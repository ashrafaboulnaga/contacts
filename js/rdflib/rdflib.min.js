(function(Q,Y){"undefined"!=typeof tabulator&&"undefined"==typeof tabulator.isExtension&&(tabulator.isExtension=!1);if("undefined"==typeof c)var c={};else{return c;throw"Internal error: RDF libray has already been loaded: $rdf already exists";}if(void 0!=c.log)throw"Internal Error: $rdf.log already defined,  util.js: "+c.log;c.log={debug:function(b){},warn:function(b){},info:function(b){},error:function(b){},success:function(b){},msg:function(b){}};c.Util={output:function(b){var a=document.createElement("div");
a.textContent=b;document.body.appendChild(a)},callbackify:function(b,a){b.callbacks={};for(var f=a.length-1;0<=f;f--)b.callbacks[a[f]]=[];b.addHook=function(a){b.callbacks[a]||(b.callbacks[a]=[])};b.addCallback=function(a,f){b.callbacks[a].push(f)};b.removeCallback=function(a,f){for(var d=0;d<b.callbacks[a].length;d++)if(b.callbacks[a][d].name==f)return b.callbacks[a].splice(d,1),!0;return!1};b.insertCallback=function(a,f){b.callbacks[a].unshift(f)};b.fireCallbacks=function(a,f){for(var d=[],g=[],
c=b.callbacks[a].length,l=c-1;0<=l;l--)b.callbacks[a][l].apply(b,f)&&d.push(b.callbacks[a][l]);for(l=d.length-1;0<=l;l--)g.push(d[l]);for(l=c;l<b.callbacks[a].length;l++)g.push(b.callbacks[a][l]);b.callbacks[a]=g}},XMLHTTPFactory:function(){if("undefined"!=typeof module&&module&&module.exports)return new (require("XMLHttpRequest").XMLHttpRequest);if("undefined"!=typeof tabulator&&tabulator.isExtension)return Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance().QueryInterface(Components.interfaces.nsIXMLHttpRequest);
if(window.XMLHttpRequest)return new window.XMLHttpRequest;if(window.ActiveXObject)try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(b){return new ActiveXObject("Microsoft.XMLHTTP")}else return!1},DOMParserFactory:function(){return tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):window.DOMParser?new DOMParser:window.ActiveXObject?new ActiveXObject("Microsoft.XMLDOM"):!1},getHTTPHeaders:function(b){b=b.getAllResponseHeaders().split("\n");
for(var a={},f=void 0,e=0;e<b.length;e++)if(0<b[e].length){var h=b[e].split(": ");"undefined"==typeof h[1]?a[f]+="\n"+h[0]:(f=h[0].toLowerCase(),a[f]=h[1])}return a},dtstamp:function(){var b=new Date,a=b.getYear()+1900,f=b.getMonth()+1,e=b.getDate(),h=b.getUTCHours(),d=b.getUTCMinutes(),b=b.getSeconds();10>f&&(f="0"+f);10>e&&(e="0"+e);10>h&&(h="0"+h);10>d&&(d="0"+d);10>b&&(b="0"+b);return a+"-"+f+"-"+e+"T"+h+":"+d+":"+b+"Z"},enablePrivilege:"undefined"!=typeof netscape&&"undefined"!=typeof netscape.security.PrivilegeManager&&
netscape.security.PrivilegeManager.enablePrivilege||function(){},disablePrivilege:"undefined"!=typeof netscape&&"undefined"!=typeof netscape.security.PrivilegeManager&&netscape.security.PrivilegeManager.disablePrivilege||function(){},RDFArrayRemove:function(b,a){for(var f=0;f<b.length;f++)if(b[f].subject.sameTerm(a.subject)&&b[f].predicate.sameTerm(a.predicate)&&b[f].object.sameTerm(a.object)&&b[f].why.sameTerm(a.why)){b.splice(f,1);return}throw"RDFArrayRemove: Array did not contain "+a+" "+a.why;
},string_startswith:function(b,a){return b.slice(0,a.length)==a},AJAR_handleNewTerm:function(b,a,f){var e=null;if("undefined"!=typeof b.sf&&(e=b.sf,"symbol"==a.termType)){b=c.Util.uri.docpart(a.uri);var h;if(0>a.uri.indexOf("#")){if(c.Util.string_startswith(a.uri,"http://dbpedia.org/resource/Category:"))return;c.Util.string_startswith(a.uri,"http://purl.org/dc/elements/1.1/")||c.Util.string_startswith(a.uri,"http://purl.org/dc/terms/")?h="http://dublincore.org/2005/06/13/dcq":c.Util.string_startswith(a.uri,
"http://xmlns.com/wot/0.1/")?h="http://xmlns.com/wot/0.1/index.rdf":c.Util.string_startswith(a.uri,"http://web.resource.org/cc/")&&(h="http://web.resource.org/cc/schema.rdf")}h&&(b=h);e&&"unrequested"!=e.getState(b)||(h&&c.log.warn("Assuming server still broken, faking redirect of <"+a.uri+"> to <"+b+">"),e.requestURI(b,f))}},ArrayIndexOf:function(b,a,f){f||(f=0);var e=b.length;for(0>f&&(f=e+f);f<e;f++)if(b[f]===a)return f;return-1}};c.Util.variablesIn=function(b){for(var a=0;a<b.statements.length;a++){var f=
b.statatements[a],e={};f.subject instanceof c.Variable&&(e[f.subject.toNT()]=!0);f.predicate instanceof c.Variable&&(e[f.predicate.toNT()]=!0);f.object instanceof c.Variable&&(e[f.object.toNT()]=!0)}return e};c.Util.heavyCompare=function(b,a,f){var e=function(a){return"bnode"===a.termType?null:a},h=function(a){a=f.statementsMatching(b).map(function(a){return""+e(a.subject)+" "+e(a.predicate)+" "+e(a.object)}).concat(f.statementsMatching(void 0,void 0,b).map(function(a){return""+e(a.subject)+" "+e(a.predicate)+
" "+e(a.object)}));a.sort();return a.join("\n")};return"bnode"===b.termType||"bnode"===a.termType?0===b.compareTerm(a)?0:h(b)>h(a)?1:h(b)<h(a)?-1:b.compareTerm(a):b.compareTerm(a)};c.Util.heavyCompareSPO=function(b,a,f){var e=c.Util.heavyCompare,h=e(b.subject,a.subject,f);return h?h:(h=e(b.predicate,a.predicate,f))?h:e(b.object,a.object,f)};c.Util.parseXML=function(b){var a;if("undefined"!=typeof tabulator&&tabulator.isExtension)a=Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser);
else{if("undefined"!=typeof module)return require("jsdom").jsdom(b,void 0,{});a=new DOMParser}return a.parseFromString(b,"application/xml")};c.Util.string={template:function(b,a){for(var f=b.split("%s"),e="",h=0;h<a.length;h++)a[h]+="",e+=f[h]+a[h];return e+f.slice(a.length).join()}};c.Util.extend=function(){var b=arguments[0]||{},a=1,f=arguments.length,e=!1,h,d,g,c;"boolean"===typeof b&&(e=b,b=arguments[1]||{},a=2);"object"===typeof b||jQuery.isFunction(b)||(b={});f===a&&(b=this,--a);for(;a<f;a++)if(null!=
(h=arguments[a]))for(d in h)g=b[d],c=h[d],b!==c&&(e&&c&&"object"===typeof c&&!c.nodeType?(g=g?g:jQuery.isArray(c)?[]:jQuery.isObject(c)?{}:c,b[d]=jQuery.extend(e,g,c)):void 0!==c&&(b[d]=c));return b};var G,K,M,C={}.hasOwnProperty;if("undefined"===typeof c||null===c)c={};null==c.Util&&(c.Util={});c.uri=function(){function b(){}b.join=function(a,f){var e,b,c,g;b=f.indexOf("#");0<b&&(f=f.slice(0,b));if(0===a.length)return f;if(0===a.indexOf("#"))return f+a;if(0<=a.indexOf(":"))return a;e=f.indexOf(":");
if(0===f.length)return a;if(0>e)return alert("Invalid base: "+f+" in join with given: "+a),a;b=f.slice(0,+e+1||9E9);if(0===a.indexOf("//"))return b+a;if(f.indexOf("//",e)===e+1){if(c=f.indexOf("/",e+3),0>c)return 0<f.length-e-3?f+"/"+a:b+a}else if(c=f.indexOf("/",e+1),0>c)return 0<f.length-e-1?f+"/"+a:b+a;if(0===a.indexOf("/"))return f.slice(0,c)+a;g=f.slice(c);e=g.lastIndexOf("/");if(0>e)return b+a;0<=e&&e<g.length-1&&(g=g.slice(0,+e+1||9E9));for(g+=a;g.match(/[^\/]*\/\.\.\//);)g=g.replace(/[^\/]*\/\.\.\//,
"");g=g.replace(/\.\//g,"");g=g.replace(/\/\.$/,"/");return f.slice(0,c)+g};b.commonHost=/^[-_a-zA-Z0-9.]+:(\/\/[^/]*)?\/[^/]*$/;b.hostpart=function(a){return(a=/[^\/]*\/\/([^\/]*)\//.exec(a))?a[1]:""};b.refTo=function(a,f){var e,b,d,g,k,l;if(!a)return f;if(a===f)return"";b=d=0;for(g=f.length;d<g&&(e=f[b],e===a[b]);b=++d);if(a.slice(0,b).match(c.Util.uri.commonHost)&&(e=f.indexOf("//"),0>e&&(e=-2),e=f.indexOf("/",e+2),"/"!==f[e+1]&&"/"!==a[e+1]&&f.slice(0,e)===a.slice(0,e)))return f.slice(e);if("#"===
f[b]&&a.length===b)return f.slice(b);for(;0<b&&"/"!==f[b-1];)b--;if(3>b||0<a.indexOf("//",b-2)||0<f.indexOf("//",b-2)||0<a.indexOf(":",b))return f;d=0;l=a.slice(b);g=0;for(k=l.length;g<k;g++)e=l[g],"/"===e&&d++;if(0===d&&b<f.length&&"#"===f[b])return"./"+f.slice(b);if(0===d&&b===f.length)return"./";e="";if(0<d)for(g=1;1<=d?g<=d:g>=d;1<=d?++g:--g)e+="../";return e+f.slice(b)};b.docpart=function(a){var f;f=a.indexOf("#");return 0>f?a:a.slice(0,f)};b.document=function(a){return c.sym(b.docpart(a.uri))};
b.protocol=function(a){var f;f=a.indexOf(":");return 0>f?null:a.slice(0,f)};return b}();c.Util.uri=c.uri;if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)){null==(M=module.exports).Util&&(M.Util={});M=c.Util;for(G in M)C.call(M,G)&&(K=M[G],module.exports.Util[G]=K);module.exports.uri=c.uri}var C={}.hasOwnProperty,I=function(b,a){function f(){this.constructor=b}for(var e in a)C.call(a,e)&&(b[e]=a[e]);f.prototype=a.prototype;b.prototype=new f;b.__super__=a.prototype;return b},
T=[].indexOf||function(b){for(var a=0,f=this.length;a<f;a++)if(a in this&&this[a]===b)return a;return-1};if("undefined"===typeof c||null===c)c={};c.Node=function(){function b(){}b.prototype.substitute=function(a){return this};return b}();c.Empty=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}I(a,b);a.prototype.termType="empty";a.prototype.toString=function(){return"()"};a.prototype.toNT=a.prototype.toString;return a}(c.Node);c.Symbol=function(b){function a(a){this.value=
this.uri=a}I(a,b);a.prototype.termType="symbol";a.prototype.toString=function(){return"<"+this.uri+">"};a.prototype.toNT=a.prototype.toString;a.prototype.sameTerm=function(a){return a?this.termType===a.termType&&this.uri===a.uri:!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.uri<a.uri?-1:this.uri>a.uri?1:0};a.prototype.XSDboolean=new a("http://www.w3.org/2001/XMLSchema#boolean");a.prototype.XSDdecimal=new a("http://www.w3.org/2001/XMLSchema#decimal");
a.prototype.XSDfloat=new a("http://www.w3.org/2001/XMLSchema#float");a.prototype.XSDinteger=new a("http://www.w3.org/2001/XMLSchema#integer");a.prototype.XSDdateTime=new a("http://www.w3.org/2001/XMLSchema#dateTime");a.prototype.integer=new a("http://www.w3.org/2001/XMLSchema#integer");return a}(c.Node);null!=c.NextId?c.log.error("Attempt to re-zero existing blank node id counter at "+c.NextId):c.NextId=0;c.NTAnonymousNodePrefix="_:n";c.BlankNode=function(b){function a(a){this.id=c.NextId++;this.value=
a?a:this.id.toString()}I(a,b);a.prototype.termType="bnode";a.prototype.toNT=function(){return c.NTAnonymousNodePrefix+this.id};a.prototype.toString=a.prototype.toNT;a.prototype.sameTerm=function(a){return a?this.termType===a.termType&&this.id===a.id:!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.id<a.id?-1:this.id>a.id?1:0};return a}(c.Node);c.Literal=function(b){function a(a,e,b){this.value=a;this.lang=e;this.datatype=b;null==this.lang&&
(this.lang=void 0);null==this.datatype&&(this.datatype=void 0)}I(a,b);a.prototype.termType="literal";a.prototype.toString=function(){return""+this.value};a.prototype.toNT=function(){var a;a=this.value;if(!1===typeof a){if("number"===typeof a)return""+a;throw Error("Value of RDF literal is not string: "+a);}a=a.replace(/\\/g,"\\\\");a=a.replace(/\"/g,'\\"');a=a.replace(/\n/g,"\\n");a='"'+a+'"';this.datatype&&(a+="^^"+this.datatype.toNT());this.lang&&(a+="@"+this.lang);return a};a.prototype.sameTerm=
function(a){return a?this.termType===a.termType&&this.value===a.value&&this.lang===a.lang&&(!this.datatype&&!a.datatype||this.datatype&&this.datatype.sameTerm(a.datatype)):!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.value<a.value?-1:this.value>a.value?1:0};return a}(c.Node);c.Collection=function(b){function a(a){var e,b,d;this.id=c.NextId++;this.elements=[];this.closed=!1;if("undefined"!==typeof a)for(b=0,d=a.length;b<d;b++)e=
a[b],this.elements.push(c.term(e))}I(a,b);a.prototype.termType="collection";a.prototype.toNT=function(){return c.NTAnonymousNodePrefix+this.id};a.prototype.toString=function(){return"("+this.elements.join(" ")+")"};a.prototype.substitute=function(a){var e,b=c.Collection,d,g,k,l;k=this.elements;l=[];d=0;for(g=k.length;d<g;d++)e=k[d],l.push(e.substitute(a));return new b(l)};a.prototype.append=function(a){return this.elements.push(a)};a.prototype.unshift=function(a){return this.elements.unshift(a)};
a.prototype.shift=function(){return this.elements.shift()};a.prototype.close=function(){return this.closed=!0};return a}(c.Node);c.Collection.prototype.sameTerm=c.BlankNode.prototype.sameTerm;c.Collection.prototype.compareTerm=c.BlankNode.prototype.compareTerm;c.term=function(b){var a,f,e,h;switch(typeof b){case "object":if(b instanceof Date)return a=function(a){return(""+(100+a)).slice(1,3)},b=""+b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"T"+a(b.getUTCHours())+":"+a(b.getUTCMinutes())+
":"+a(b.getUTCSeconds())+"Z",new c.Literal(b,void 0,c.Symbol.prototype.XSDdateTime);if(b instanceof Array){f=new c.Collection;e=0;for(h=b.length;e<h;e++)a=b[e],f.append(c.term(a));return f}return b;case "string":return new c.Literal(b);case "number":return a=0<=(""+b).indexOf("e")?c.Symbol.prototype.XSDfloat:0<=(""+b).indexOf(".")?c.Symbol.prototype.XSDdecimal:c.Symbol.prototype.XSDinteger,new c.Literal(""+b,void 0,a);case "boolean":return new c.Literal(b?"1":"0",void 0,c.Symbol.prototype.XSDboolean);
case "undefined":return}throw"Can't make term from "+b+" of type "+typeof b;};c.Statement=function(){function b(a,f,e,b){this.subject=c.term(a);this.predicate=c.term(f);this.object=c.term(e);null!=b&&(this.why=b)}b.prototype.toNT=function(){return[this.subject.toNT(),this.predicate.toNT(),this.object.toNT()].join(" ")+" ."};b.prototype.toString=b.prototype.toNT;b.prototype.substitute=function(a){return new c.Statement(this.subject.substitute(a),this.predicate.substitute(a),this.object.substitute(a),
this.why)};return b}();c.st=function(b,a,f,e){return new c.Statement(b,a,f,e)};c.Formula=function(b){function a(){this.statements=[];this.constraints=[];this.initBindings=[];this.optional=[]}I(a,b);a.prototype.termType="formula";a.prototype.toNT=function(){return"{"+this.statements.join("\n")+"}"};a.prototype.toString=a.prototype.toNT;a.prototype.add=function(a,e,b,d){return this.statements.push(new c.Statement(a,e,b,d))};a.prototype.addStatement=function(a){return this.statements.push(a)};a.prototype.substitute=
function(a){var e,b,d,g,k;e=new c.Formula;k=this.statements;d=0;for(g=k.length;d<g;d++)b=k[d],e.addStatement(b.substitute(a));return e};a.prototype.sym=function(a,e){if(null!=e)throw"This feature (kb.sym with 2 args) is removed. Do not assume prefix mappings.";return new c.Symbol(a)};a.prototype.literal=function(a,e,b){return new c.Literal(""+a,e,b)};a.prototype.bnode=function(a){return new c.BlankNode(a)};a.prototype.formula=function(){return new c.Formula};a.prototype.collection=function(){return new c.Collection};
a.prototype.list=function(a){var e,b,d,g;b=new c.Collection;if(a)for(d=0,g=a.length;d<g;d++)e=a[d],b.append(e);return b};a.prototype.variable=function(a){return new c.Variable(a)};a.prototype.ns=function(a){return function(e){return new c.Symbol(a+(null!=e?e:""))}};a.prototype.fromNT=function(a){var e,b,d;switch(a[0]){case "<":return c.sym(a.slice(1,-1));case '"':e=d=void 0;b=a.lastIndexOf('"');if(b<a.length-1)if("@"===a[b+1])d=a.slice(b+2);else if("^^"===a.slice(b+1,b+3))e=c.fromNT(a.slice(b+3));
else throw"Can't convert string from NT: "+a;a=a.slice(1,b);a=a.replace(/\\"/g,'"');a=a.replace(/\\n/g,"\n");a=a.replace(/\\\\/g,"\\");return c.lit(a,d,e);case "_":return e=new c.BlankNode,e.id=parseInt(a.slice(3)),c.NextId--,e;case "?":return new c.Variable(a.slice(1))}throw"Can't convert from NT: "+a;};a.prototype.sameTerm=function(a){return a?this.hashString()===a.hashString():!1};a.prototype.each=function(a,b,c,d){var g,k;g=[];k=this.statementsMatching(a,b,c,d,!1);if(null==a)for(b=0,c=k.length;b<
c;b++)a=k[b],g.push(a.subject);else if(null==b)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.predicate);else if(null==c)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.object);else if(null==d)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.why);return g};a.prototype.any=function(a,b,c,d){d=this.anyStatementMatching(a,b,c,d);if(null!=d){if(null==a)return d.subject;if(null==b)return d.predicate;if(null==c)return d.object}};a.prototype.holds=function(a,b,c,d){return null!=this.anyStatementMatching(a,b,c,d)};a.prototype.holdsStatement=
function(a){return this.holds(a.subject,a.predicate,a.object,a.why)};a.prototype.the=function(a,b,h,d){d=this.any(a,b,h,d);null==d&&c.log.error("No value found for the() {"+a+" "+b+" "+h+"}.");return d};a.prototype.whether=function(a,b,c,d){return this.statementsMatching(a,b,c,d,!1).length};a.prototype.transitiveClosure=function(a,b,c){var d,g,k,l,m,p;g={};d={};for(l in a)C.call(a,l)&&(m=a[l],d[l]=m);for(;;){a:{a=void 0;for(a in d)if(C.call(d,a)){l=a;break a}l=void 0}if(null==l)return g;a=c?this.each(void 0,
b,this.fromNT(l)):this.each(this.fromNT(l),b);m=0;for(p=a.length;m<p;m++)k=a[m],k=k.toNT(),k in g||k in d||(d[k]=d[l]);g[l]=d[l];delete d[l]}};a.prototype.findMembersNT=function(a){var b,c,d,g,k,l,m,p,q;c={};c[a.toNT()]=!0;a={};c=this.transitiveClosure(c,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!0);for(d in c)if(C.call(c,d)){p=this.statementsMatching(void 0,this.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)b=p[g],a[b.subject.toNT()]=
b;p=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#domain"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)for(b=p[g],q=this.statementsMatching(void 0,b),k=0,m=q.length;k<m;k++)b=q[k],a[b.subject.toNT()]=b;p=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#range"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)for(b=p[g],q=this.statementsMatching(void 0,b),m=0,k=q.length;m<k;m++)b=q[m],a[b.object.toNT()]=b}return a};a.prototype.NTtoURI=function(a){var b,c,d;c={};for(b in a)C.call(a,
b)&&(d=a[b],"<"===b[0]&&(c[b.slice(1,-1)]=d));return c};a.prototype.findTypeURIs=function(a){return this.NTtoURI(this.findTypesNT(a))};a.prototype.findMemberURIs=function(a){return this.NTtoURI(this.findMembersNT(a))};a.prototype.findTypesNT=function(a){var b,c,d,g,k,l,m,p,q;d=[];p=this.statementsMatching(a,void 0,void 0);g=0;for(l=p.length;g<l;g++)if(c=p[g],"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"===c.predicate.uri)d[c.object.toNT()]=c;else for(q=this.each(c.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#domain")),
k=0,m=q.length;k<m;k++)b=q[k],d[b.toNT()]=c;m=this.statementsMatching(void 0,void 0,a);b=0;for(k=m.length;b<k;b++)for(c=m[b],p=this.each(c.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#range")),g=0,l=p.length;g<l;g++)a=p[g],d[a.toNT()]=c;return this.transitiveClosure(d,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!1)};a.prototype.findSuperClassesNT=function(a){var b;b=[];b[a.toNT()]=!0;return this.transitiveClosure(b,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),
!1)};a.prototype.findSubClassesNT=function(a){var b;b=[];b[a.toNT()]=!0;return this.transitiveClosure(b,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!0)};a.prototype.topTypeURIs=function(a){var b,c,d,g,k,l,m,p;g=[];for(c in a)if(C.call(a,c)){k=a[c];d=0;p=this.each(this.sym(c),this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"));l=0;for(m=p.length;l<m;l++)if(b=p[l],"http://www.w3.org/2000/01/rdf-schema#Resource"!==b.uri){d++;break}d||(g[c]=k)}g["http://www.w3.org/2000/01/rdf-schema#Resource"]&&
delete g["http://www.w3.org/2000/01/rdf-schema#Resource"];g["http://www.w3.org/2002/07/owl#Thing"]&&delete g["http://www.w3.org/2002/07/owl#Thing"];return g};a.prototype.bottomTypeURIs=function(a){var b,c,d,g,k,l,m,p,q;b=[];for(g in a)if(C.call(a,g)){l=a[g];k=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),this.sym(g));c=!0;m=0;for(p=k.length;m<p;m++)if(d=k[m],q=d.uri,0<=T.call(a,q)){c=!1;break}c&&(b[g]=l)}return b};a.prototype.serialize=function(a,b,h){var d;d=c.Serializer(this);
d.suggestNamespaces(this.namespaces);d.setBase(a);a=h?this.statementsMatching(void 0,void 0,void 0,h):this.statements;switch(null!=b?b:"text/n3"){case "application/rdf+xml":b=d.statementsToXML(a);break;case "text/n3":case "text/turtle":b=d.statementsToN3(a);break;default:throw"serialize: Content-type "+b(NaN);}return b};return a}(c.Node);c.sym=function(b){return new c.Symbol(b)};c.lit=c.Formula.prototype.literal;c.Namespace=c.Formula.prototype.ns;c.variable=c.Formula.prototype.variable;c.Variable=
function(b){function a(a){this.base="varid:";this.uri=c.Util.uri.join(a,this.base)}I(a,b);a.prototype.termType="variable";a.prototype.toNT=function(){return this.uri.slice(0,this.base.length)===this.base?"?"+this.uri.slice(this.base.length):"?"+this.uri};a.prototype.toString=a.prototype.toNT;a.prototype.hashString=a.prototype.toNT;a.prototype.substitute=function(a){var b;return null!=(b=a[this.toNT()])?b:this};a.prototype.sameTerm=function(a){a||!1;return this.termType===a.termType&&this.uri===a.uri};
return a}(c.Node);c.Literal.prototype.classOrder=1;c.Collection.prototype.classOrder=3;c.Formula.prototype.classOrder=4;c.Symbol.prototype.classOrder=5;c.BlankNode.prototype.classOrder=6;c.Variable.prototype.classOrder=7;c.fromNT=c.Formula.prototype.fromNT;c.graph=function(){return new c.IndexedFormula};if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0))for(G in c)C.call(c,G)&&(K=c[G],module.exports[G]=K);c.RDFParser=function(b){this.frameFactory=function(a,b,e){return{NODE:1,
ARC:2,parent:b,parser:a,store:a.store,element:e,lastChild:0,base:null,lang:null,node:null,nodeType:null,listIndex:1,rdfid:null,datatype:null,collection:!1,terminateFrame:function(){this.collection&&this.node.close()},addSymbol:function(a,b){b=c.Util.uri.join(b,this.base);this.node=this.store.sym(b);this.nodeType=a},loadTriple:function(){this.parent.parent.collection?this.parent.parent.node.append(this.node):this.store.add(this.parent.parent.node,this.parent.node,this.node,this.parser.why);if(null!=
this.parent.rdfid){var a=this.store.sym(c.Util.uri.join("#"+this.parent.rdfid,this.base));this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#Statement"),this.parser.why);this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#subject"),this.parent.parent.node,this.parser.why);this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#predicate"),this.parent.node,this.parser.why);
this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#object"),this.node,this.parser.why)}},isTripleToLoad:function(){return null!=this.parent&&null!=this.parent.parent&&this.nodeType===this.NODE&&this.parent.nodeType===this.ARC&&this.parent.parent.nodeType===this.NODE},addNode:function(a){this.addSymbol(this.NODE,a);this.isTripleToLoad()&&this.loadTriple()},addCollection:function(){this.nodeType=this.NODE;this.node=this.store.collection();this.collection=!0;this.isTripleToLoad()&&
this.loadTriple()},addCollectionArc:function(){this.nodeType=this.ARC},addBNode:function(a){this.node=null!=a?null!=this.parser.bnodes[a]?this.parser.bnodes[a]:this.parser.bnodes[a]=this.store.bnode():this.store.bnode();this.nodeType=this.NODE;this.isTripleToLoad()&&this.loadTriple()},addArc:function(a){"http://www.w3.org/1999/02/22-rdf-syntax-ns#li"===a&&(a="http://www.w3.org/1999/02/22-rdf-syntax-ns#_"+this.parent.listIndex,this.parent.listIndex++);this.addSymbol(this.ARC,a)},addLiteral:function(a){this.node=
this.parent.datatype?this.store.literal(a,"",this.store.sym(this.parent.datatype)):this.store.literal(a,this.lang);this.nodeType=this.NODE;this.isTripleToLoad()&&this.loadTriple()}}};this.getAttributeNodeNS=function(a,b,c){var h=null;if(a.getAttributeNodeNS)h=a.getAttributeNodeNS(b,c);else{a=a.attributes;for(var d,g,k=0;k<a.length;++k)if(d=a[k],d.namespaceURI===b&&(g=d.prefix?d.prefix+":"+c:c,g===d.nodeName)){h=d;break}}return h};this.store=b;this.bnodes={};this.why=null;this.reify=!1;this.parse=
function(a,b,c){var h=a.childNodes;this.cleanParser();var d;if(9===a.nodeType)for(a=0;a<h.length;a++){if(1===h[a].nodeType){d=h[a];break}}else if(1===a.nodeType)d=a;else throw Error("RDFParser: can't find root in "+b+". Halting. ");this.why=c;c=this.frameFactory(this);this.base=b;c.base=b;c.lang="";this.parseDOM(this.buildFrame(c,d));return!0};this.parseDOM=function(a){for(var b,e=function(a){var b="";if(null==a.namespaceURI)throw Error("RDF/XML syntax error: No namespace for "+a.localName+" in "+
this.base);a.namespaceURI&&(b+=a.namespaceURI);a.localName?b+=a.localName:a.nodeName&&(b=0<=a.nodeName.indexOf(":")?b+a.nodeName.split(":")[1]:b+a.nodeName);return b}.bind(this),h=!0;a.parent;){var d=a.element,g=d.attributes;if(3===d.nodeType||4===d.nodeType)a.parent.nodeType==a.NODE&&(a.addArc("http://www.w3.org/1999/02/22-rdf-syntax-ns#value"),a=this.buildFrame(a)),a.addLiteral(d.nodeValue);else if("http://www.w3.org/1999/02/22-rdf-syntax-ns#RDF"!==e(d))if(a.parent&&a.parent.collection&&(a.addCollectionArc(),
a=this.buildFrame(a,a.element),a.parent.element=null),a.parent&&a.parent.nodeType&&a.parent.nodeType!==a.ARC){a.addArc(e(d));this.reify&&(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","ID"))&&(a.rdfid=b.nodeValue,d.removeAttributeNode(b));b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","parseType");var k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","datatype");k&&(a.datatype=k.nodeValue,d.removeAttributeNode(k));b&&(k=
b.nodeValue,"Literal"===k?(a.datatype="http://www.w3.org/1999/02/22-rdf-syntax-ns#XMLLiteral",a=this.buildFrame(a),a.addLiteral(d),h=!1):"Resource"===k?(a=this.buildFrame(a,a.element),a.parent.element=null,a.addBNode()):"Collection"===k&&(a=this.buildFrame(a,a.element),a.parent.element=null,a.addCollection()),d.removeAttributeNode(b));if(0!==g.length)for(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","resource"),k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
"nodeID"),a=this.buildFrame(a),b?(a.addNode(b.nodeValue),d.removeAttributeNode(b)):k?(a.addBNode(k.nodeValue),d.removeAttributeNode(k)):a.addBNode(),d=g.length-1;0<=d;d--)b=this.buildFrame(a),b.addArc(e(g[d])),"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"===e(g[d])?this.buildFrame(b).addNode(g[d].nodeValue):this.buildFrame(b).addLiteral(g[d].nodeValue);else 0===d.childNodes.length&&this.buildFrame(a).addLiteral("")}else{k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
"about");b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","ID");if(k&&b)throw Error("RDFParser: "+d.nodeName+" has both rdf:id and rdf:about. Halting. Only one of these properties may be specified on a node.");!k&&b?(a.addNode("#"+b.nodeValue),d.removeAttributeNode(b)):null==k&&null==b?(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","nodeID"))?(a.addBNode(b.nodeValue),d.removeAttributeNode(b)):a.addBNode():(a.addNode(k.nodeValue),d.removeAttributeNode(k));
b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","type");"http://www.w3.org/1999/02/22-rdf-syntax-ns#Description"!==e(d)&&(b={nodeValue:e(d)});null!=b&&(this.store.add(a.node,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.store.sym(c.Util.uri.join(b.nodeValue,a.base)),this.why),b.nodeName&&d.removeAttributeNode(b));for(d=g.length-1;0<=d;d--)this.store.add(a.node,this.store.sym(e(g[d])),this.store.literal(g[d].nodeValue,a.lang),this.why)}for(d=a.element;a.parent;){for(g=
a;null==d;)a=a.parent,d=a.element;if((b=d.childNodes&&d.childNodes[a.lastChild])&&h)if(1!==b.nodeType&&3!==b.nodeType&&4!==b.nodeType||(3===b.nodeType||4===b.nodeType)&&1!==d.childNodes.length)a.lastChild++;else{a.lastChild++;a=this.buildFrame(g,d.childNodes[a.lastChild-1]);break}else{a.terminateFrame();if(!(a=a.parent))break;d=a.element;h=!0}}}};this.cleanParser=function(){this.bnodes={};this.why=null};this.buildFrame=function(a,b){var e=this.frameFactory(this,a,b);a&&(e.base=a.base,e.lang=a.lang);
if(!b||3===b.nodeType||4===b.nodeType)return e;var h=b.attributes,d=b.getAttributeNode("xml:base");null!=d&&(e.base=d.nodeValue,b.removeAttribute("xml:base"));d=b.getAttributeNode("xml:lang");null!=d&&(e.lang=d.nodeValue,b.removeAttribute("xml:lang"));for(d=h.length-1;0<=d;d--)if("xml"===h[d].nodeName.substr(0,3)){if("xmlns:"===h[d].name.slice(0,6)){var g=h[d].nodeValue;this.base&&(g=c.Util.uri.join(g,this.base));this.store.setPrefixForURI(h[d].name.slice(6),g)}b.removeAttributeNode(h[d])}return e}};
c.N3Parser=function(){function b(a,b,c,g,f,e,k,l){"undefined"==typeof b&&(b=null);"undefined"==typeof c&&(c="");"undefined"==typeof g&&(g=null);"undefined"==typeof f&&(f="");"undefined"==typeof k&&(k="");"undefined"==typeof l&&(l=null);this._bindings=new d([]);this._flags=k;""!=c&&(m(0<=c.indexOf(":"),"Document URI not absolute: "+c),this._bindings[""]=c+"#");this._store=a;f&&a.setGenPrefix(f);this._thisDoc=c;this.source=a.sym(c);this.previousLine=this.startOfLine=this.statementCount=this.lines=0;
this._genPrefix=f;this.keywords=new h("a this bind has is of true false".split(" "));this.keywordsSet=0;this._anonymousNodes=new d([]);this._variables=new d([]);this._parentVariables=new d([]);this._reason=l;this._reason2=null;this._baseURI=g?g:c?c:null;m(!this._baseURI||0<=this._baseURI.indexOf(":"));this._genPrefix||(this._genPrefix=this._thisDoc?this._thisDoc+"#_g":RDFSink_uniqueURI());this._context=this._formula=null==b?this._thisDoc?a.formula(c+"#_formula"):a.formula():b;this._parentContext=
null}function a(a,b,c,f,e){return"Line "+(b+1)+" of <"+a+">: Bad syntax: "+e+'\nat: "'+g(c,f,f+30)+'"'}var f={encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var g=a.charCodeAt(c);128>g?b+=String.fromCharCode(g):(127<g&&2048>g?b+=String.fromCharCode(g>>6|192):(b+=String.fromCharCode(g>>12|224),b+=String.fromCharCode(g>>6&63|128)),b+=String.fromCharCode(g&63|128))}return b},decode:function(a){for(var b="",c=0;c<a.length;){var g=a.charCodeAt(c);128>g?(b+=String.fromCharCode(g),
c++):191<g&&224>g?(b+=String.fromCharCode((g&31)<<6|a.charCodeAt(c+1)&63),c+=2):(b+=String.fromCharCode((g&15)<<12|(a.charCodeAt(c+1)&63)<<6|a.charCodeAt(c+2)&63),c+=3)}return b}},e=function(a){return a},h=function(a){return a},d=function(a){if(0<a.length)throw"missing.js: oops nnonempty dict not imp";return[]},g=function(a,b,c){if("undefined"==typeof a.slice)throw"@@ mising.js: No .slice function for "+a+" of type "+typeof a;return"undefined"==typeof c||null==c?a.slice(b):a.slice(b,c)},k=Error("dummy error stop iteration"),
l=function(a){this.last=0;this.li=a;this.next=function(){if(this.last==this.li.length)throw k;return this.li[this.last++]};return this},m=function(a,b){if(!a){if(b)throw"python Assertion failed: "+b;throw"(python) Assertion failed.";}};String.prototype.encode=function(a){if("utf-8"!=a)throw"UTF8_converter: can only do utf-8";return f.encode(this)};String.prototype.decode=function(a){if("utf-8"!=a)throw"UTF8_converter: can only do utf-8";return this};var p=RegExp("^([-+]?[0-9]+)(\\.[0-9]+)?(e[-+]?[0-9]+)?",
"g"),q=/^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9](T[0-9][0-9]:[0-9][0-9](:[0-9][0-9](\.[0-9]*)?)?)?Z?/,u=RegExp('[\\\\\\r\\n\\"]',"g"),v=RegExp("^[a-zA-Z0-9]+(-[a-zA-Z0-9]+)?","g");b.prototype.here=function(a){return this._genPrefix+"_L"+this.lines+"C"+(a-this.startOfLine+1)};b.prototype.formula=function(){return this._formula};b.prototype.loadStream=function(a){return this.loadBuf(a.read())};b.prototype.loadBuf=function(a){this.startDoc();this.feed(a);return this.endDoc()};b.prototype.feed=function(b){b=
b.decode("utf-8");for(var c=0;0<=c;){var g=this.skipSpace(b,c);if(0>g)break;c=this.directiveOrStatement(b,g);if(0>c)throw a(this._thisDoc,this.lines,b,g,"expected directive or statement");}};b.prototype.directiveOrStatement=function(a,b){var c=this.skipSpace(a,b);if(0>c)return c;var g=this.directive(a,c);if(0<=g)return this.checkDot(a,g);g=this.statement(a,c);return 0<=g?this.checkDot(a,g):g};b.prototype.tok=function(a,b,f){if("@"==g(b,f,f+1))f+=1;else if(0>c.Util.ArrayIndexOf(this.keywords,a))return-1;
var e=f+a.length;return g(b,f,e)==a&&0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~".indexOf(b.charAt(e))?e:-1};b.prototype.directive=function(b,f){var e=this.skipSpace(b,f);if(0>e)return e;var d=new h([]),e=this.tok("bind",b,f);if(0<e)throw a(this._thisDoc,this.lines,b,f,"keyword bind is obsolete: use @prefix");e=this.tok("keywords",b,f);if(0<e){f=this.commaSeparatedList(b,e,d,!1);if(0>f)throw a(this._thisDoc,this.lines,b,f,"'@keywords' needs comma separated list of words");this.setKeywords(g(d,null,
null));return f}e=this.tok("forAll",b,f);if(0<e){f=this.commaSeparatedList(b,e,d,!0);if(0>f)throw a(this._thisDoc,this.lines,b,f,"Bad variable list after @forAll");e=new l(d);try{for(;;){var t=e.next();if(0>c.Util.ArrayIndexOf(this._variables,t)||0<=c.Util.ArrayIndexOf(this._parentVariables,t))this._variables[t]=this._context.newUniversal(t)}}catch(L){if(L!=k)throw L;}return f}e=this.tok("forSome",b,f);if(0<e){f=this.commaSeparatedList(b,e,d,this.uri_ref2);if(0>f)throw a(this._thisDoc,this.lines,
b,f,"Bad variable list after @forSome");e=new l(d);try{for(;;)t=e.next(),this._context.declareExistential(t)}catch(p){if(p!=k)throw p;}return f}e=this.tok("prefix",b,f);if(0<=e){t=new h([]);f=this.qname(b,e,t);if(0>f)throw a(this._thisDoc,this.lines,b,e,"expected qname after @prefix");e=this.uri_ref2(b,f,t);if(0>e)throw a(this._thisDoc,this.lines,b,f,"expected <uriref> after @prefix _qname_");d=t[1].uri;this._baseURI?d=c.Util.uri.join(d,this._baseURI):m(0<=d.indexOf(":"),"With no base URI, cannot handle relative URI for NS");
m(0<=d.indexOf(":"));this._bindings[t[0][0]]=d;this.bind(t[0][0],encodeURI(d));return e}e=this.tok("base",b,f);if(0<=e){t=new h([]);f=this.uri_ref2(b,e,t);if(0>f)throw a(this._thisDoc,this.lines,b,e,"expected <uri> after @base ");d=t[0].uri;if(this._baseURI)d=c.Util.uri.join(d,this._baseURI);else throw a(this._thisDoc,this.lines,b,e,"With no previous base URI, cannot use relative URI in @base  <"+d+">");m(0<=d.indexOf(":"));this._baseURI=d;return f}return-1};b.prototype.bind=function(a,b){""!=a&&
this._store.setPrefixForURI(a,b)};b.prototype.setKeywords=function(a){null==a?this.keywordsSet=0:(this.keywords=a,this.keywordsSet=1)};b.prototype.startDoc=function(){};b.prototype.endDoc=function(){return this._formula};b.prototype.makeStatement=function(a){a[0].add(a[2],a[1],a[3],this.source);this.statementCount+=1};b.prototype.statement=function(b,c){var g=new h([]);c=this.object(b,c,g);if(0>c)return c;g=this.property_list(b,c,g[0]);if(0>g)throw a(this._thisDoc,this.lines,b,c,"expected propertylist");
return g};b.prototype.subject=function(a,b,c){return this.item(a,b,c)};b.prototype.verb=function(b,c,f){var d=this.skipSpace(b,c);if(0>d)return d;var k=new h([]),d=this.tok("has",b,c);if(0<=d){c=this.prop(b,d,k);if(0>c)throw a(this._thisDoc,this.lines,b,d,"expected property after 'has'");f.push(new e(["->",k[0]]));return c}d=this.tok("is",b,c);if(0<=d){c=this.prop(b,d,k);if(0>c)throw a(this._thisDoc,this.lines,b,d,"expected <property> after 'is'");d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,
this.lines,b,c,"End of file found, expected property after 'is'");c=d;d=this.tok("of",b,c);if(0>d)throw a(this._thisDoc,this.lines,b,c,"expected 'of' after 'is' <prop>");f.push(new e(["<-",k[0]]));return d}d=this.tok("a",b,c);if(0<=d)return f.push(new e(["->",this._store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type")])),d;if("<="==g(b,c,c+2))return f.push(new e(["<-",this._store.sym("http://www.w3.org/2000/10/swap/log#implies")])),c+2;if("="==g(b,c,c+1)){if(">"==g(b,c+1,c+2))return f.push(new e(["->",
this._store.sym("http://www.w3.org/2000/10/swap/log#implies")])),c+2;f.push(new e(["->",this._store.sym("http://www.w3.org/2002/07/owl#sameAs")]));return c+1}if(":="==g(b,c,c+2))return f.push(new e(["->","http://www.w3.org/2000/10/swap/log#becomes"])),c+2;d=this.prop(b,c,k);if(0<=d)return f.push(new e(["->",k[0]])),d;if(">-"==g(b,c,c+2)||"<-"==g(b,c,c+2))throw a(this._thisDoc,this.lines,b,d,">- ... -> syntax is obsolete.");return-1};b.prototype.prop=function(a,b,c){return this.item(a,b,c)};b.prototype.item=
function(a,b,c){return this.path(a,b,c)};b.prototype.blankNode=function(a){return this._context.bnode(a,this._reason2)};b.prototype.path=function(b,c,f){c=this.nodeOrLiteral(b,c,f);if(0>c)return c;for(;0<="!^.".indexOf(g(b,c,c+1));){var d=g(b,c,c+1);if("."==d){var k=g(b,c+1,c+2);if(!k||0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(k)&&0>":?<[{(".indexOf(k))break}var k=f.pop(),h=this.blankNode(this.here(c));c=this.node(b,c+1,f);if(0>c)throw a(this._thisDoc,this.lines,b,c,"EOF found in middle of path syntax");
var l=f.pop();"^"==d?this.makeStatement(new e([this._context,l,h,k])):this.makeStatement(new e([this._context,l,k,h]));f.push(h)}return c};b.prototype.anonymousNode=function(a){var b=this._anonymousNodes[a];if(b)return b;b=this._store.bnode(this._context,this._reason2);return this._anonymousNodes[a]=b};b.prototype.node=function(b,c,f,n){"undefined"==typeof n&&(n=null);var t=n;n=this.skipSpace(b,c);if(0>n)return n;c=n;n=g(b,c,c+1);if("["==n){var m=this.here(c);n=this.skipSpace(b,c+1);if(0>n)throw a(this._thisDoc,
this.lines,b,c,"EOF after '['");if("="==g(b,n,n+1)){c=n+1;var p=new h([]);n=this.objectList(b,c,p);if(0<=n){t=p[0];if(1<p.length){p=new l(p);try{for(;;){var q=p.next();this.makeStatement(new e([this._context,this._store.sym("http://www.w3.org/2002/07/owl#sameAs"),t,q]))}}catch(R){if(R!=k)throw R;}}n=this.skipSpace(b,n);if(0>n)throw a(this._thisDoc,this.lines,b,c,"EOF when objectList expected after [ = ");";"==g(b,n,n+1)&&(n+=1)}else throw a(this._thisDoc,this.lines,b,c,"objectList expected after [= ");
}null==t&&(t=this.blankNode(m));c=this.property_list(b,n,t);if(0>c)throw a(this._thisDoc,this.lines,b,n,"property_list expected");n=this.skipSpace(b,c);if(0>n)throw a(this._thisDoc,this.lines,b,c,"EOF when ']' expected after [ <propertyList>");if("]"!=g(b,n,n+1))throw a(this._thisDoc,this.lines,b,n,"']' expected");f.push(t);return n+1}if("{"==n){n=g(b,c+1,c+2);if("$"==n){n=c+1+1;t=new h([]);for(m=!0;;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed '$}', found end.");if("$}"==
g(b,c,c+2)){n=c+2;break}if(m)m=!1;else if(","==g(b,c,c+1))c+=1;else throw a(this._thisDoc,this.lines,b,c,"expected: ','");q=new h([]);n=this.item(b,c,q);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected item in set or '$}'");t.push(q[0])}f.push(this._store.newSet(t,this._context))}else{n=c+1;q=this._parentContext;this._parentContext=this._context;m=this._anonymousNodes;p=this._parentVariables;this._parentVariables=this._variables;this._anonymousNodes=new d([]);this._variables=this._variables.slice();
var S=this._reason2;this._reason2=null;null==t&&(t=this._store.formula());for(this._context=t;;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed '}', found end.");if("}"==g(b,c,c+1)){n=c+1;break}n=this.directiveOrStatement(b,c);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected statement or '}'");}this._anonymousNodes=m;this._variables=this._parentVariables;this._parentVariables=p;this._context=this._parentContext;this._reason2=S;this._parentContext=q;f.push(t.close())}return n}if("("==
n){m=this._store.list;n=g(b,c+1,c+2);"$"==n&&(m=this._store.newSet,c+=1);n=c+1;for(t=new h([]);;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed ')', found end.");if(")"==g(b,c,c+1)){n=c+1;break}q=new h([]);n=this.item(b,c,q);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected item in list or ')'");t.push(q[0])}f.push(m(t,this._context));return n}n=this.tok("this",b,c);if(0<=n)throw a(this._thisDoc,this.lines,b,c,"Keyword 'this' was ancient N3. Now use @forSome and @forAll keywords.");
n=this.tok("true",b,c);if(0<=n)return f.push(!0),n;n=this.tok("false",b,c);return 0<=n?(f.push(!1),n):null==t&&(n=this.uri_ref2(b,c,f),0<=n)?n:-1};b.prototype.property_list=function(b,c,f){for(;;){var d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,this.lines,b,c,"EOF found when expected verb in property list");if(":-"==g(b,d,d+2)){c=d+2;var t=new h([]),d=this.node(b,c,t,f);if(0>d)throw a(this._thisDoc,this.lines,b,c,"bad {} or () or [] node after :- ");c=d}else{c=d;t=new h([]);d=this.verb(b,c,
t);if(0>=d)return c;var m=new h([]);c=this.objectList(b,d,m);if(0>c)throw a(this._thisDoc,this.lines,b,d,"objectList expected");d=new l(m);try{for(;;){var p=d.next(),q=t[0],R=q[1];"->"==q[0]?this.makeStatement(new e([this._context,R,f,p])):this.makeStatement(new e([this._context,R,p,f]))}}catch(S){if(S!=k)throw S;}d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,this.lines,b,d,"EOF found in list of objects");if(";"!=g(b,c,c+1))return c;c+=1}}};b.prototype.commaSeparatedList=function(b,c,f,d){var e=
this.skipSpace(b,c);if(0>e)throw a(this._thisDoc,this.lines,b,e,"EOF found expecting comma sep list");if("."==b.charAt(e))return c;e=d?this.uri_ref2(b,e,f):this.bareWord(b,e,f);if(0>e)return-1;for(;;){c=this.skipSpace(b,e);if(0>c)return c;e=g(b,c,c+1);if(","!=e)return"."!=e?-1:c;e=d?this.uri_ref2(b,c+1,f):this.bareWord(b,c+1,f);if(0>e)throw a(this._thisDoc,this.lines,b,e,"bad list content");}};b.prototype.objectList=function(b,c,f){c=this.object(b,c,f);if(0>c)return-1;for(;;){c=this.skipSpace(b,c);
if(0>c)throw a(this._thisDoc,this.lines,b,c,"EOF found after object");if(","!=g(b,c,c+1))return c;c=this.object(b,c+1,f);if(0>c)return c}};b.prototype.checkDot=function(b,c){var f=this.skipSpace(b,c);if(0>f)return f;if("."==g(b,f,f+1))return f+1;if("}"==g(b,f,f+1)||"]"==g(b,f,f+1))return f;throw a(this._thisDoc,this.lines,b,f,"expected '.' or '}' or ']' at end of statement");};b.prototype.uri_ref2=function(b,f,e){var d=new h([]),k=this.qname(b,f,d);if(0<=k){var l=d[0],d=l[0],l=l[1];if(null==d){m(0,
"not used?");var p=this._baseURI+"#"}else if(p=this._bindings[d],!p){if("_"==d)return e.push(this.anonymousNode(l)),k;throw a(this._thisDoc,this.lines,b,f,"Prefix "+d+" not bound.");}b=this._store.sym(p+l);0<=c.Util.ArrayIndexOf(this._variables,b)?e.push(this._variables[b]):e.push(b);return k}f=this.skipSpace(b,f);if(0>f)return-1;if("?"==b.charAt(f))return d=new h([]),k=this.variable(b,f,d),0<k?(e.push(d[0]),k):-1;if("<"==b.charAt(f)){for(d=f+=1;f<b.length;){if(">"==b.charAt(f))return k=g(b,d,f),
this._baseURI?k=c.Util.uri.join(k,this._baseURI):m(0<=k.indexOf(":"),"With no base URI, cannot deal with relative URIs"),"#"==g(b,f-1,f)&&"#"!=g(k,-1,null)&&(k+="#"),b=this._store.sym(k),0<=c.Util.ArrayIndexOf(this._variables,b)?e.push(this._variables[b]):e.push(b),f+1;f+=1}throw a(this._thisDoc,this.lines,b,k,"unterminated URI reference");}if(this.keywordsSet){d=new h([]);k=this.bareWord(b,f,d);if(0>k)return-1;if(0<=c.Util.ArrayIndexOf(this.keywords,d[0]))throw a(this._thisDoc,this.lines,b,f,'Keyword "'+
d[0]+'" not allowed here.');e.push(this._store.sym(this._bindings[""]+d[0]));return k}return-1};b.prototype.skipSpace=function(a,b){for(var c=b?b:0;c<a.length;c++){var f=a.charAt(c);if(0>" \n\r\t\f\x0B\u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000".indexOf(f))if("#"===a.charAt(c))for(;;c++){if(c===a.length)return-1;if("\n"===a.charAt(c)){this.lines+=1;break}}else return c;else"\n"===a.charAt(c)&&(this.lines+=1)}return-1};b.prototype.variable=function(b,
c,f){var d=this.skipSpace(b,c);if(0>d||"?"!=g(b,d,d+1))return-1;c=d+=1;if(0<="0123456789-".indexOf(b.charAt(d)))throw a(this._thisDoc,this.lines,b,d,"Varible name can't start with '"+b.charAt(d)+"s'");for(;c<b.length&&0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(b.charAt(c));)c+=1;if(null==this._parentContext)throw a(this._thisDoc,this.lines,b,d,"Can't use ?xxx syntax for variable in outermost level: "+g(b,d-1,c));f.push(this._store.variable(g(b,d,c)));return c};b.prototype.bareWord=function(a,
b,c){var f=this.skipSpace(a,b);if(0>f)return-1;b=a.charAt(f);if(0<="0123456789-".indexOf(b)||0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(b))return-1;for(b=f;b<a.length&&0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(a.charAt(b));)b+=1;c.push(g(a,f,b));return b};b.prototype.qname=function(a,b,f){b=this.skipSpace(a,b);if(0>b)return-1;var g=a.charAt(b);if(0<="0123456789-+".indexOf(g))return-1;if(0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g)){var d=g;for(b+=1;b<a.length;)if(g=a.charAt(b),
0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g))d+=g,b+=1;else break}else d="";if(b<a.length&&":"==a.charAt(b)){var k=d;b+=1;for(d="";b<a.length;)if(g=a.charAt(b),0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g))d+=g,b+=1;else break;f.push(new e([k,d]));return b}return d&&this.keywordsSet&&0>c.Util.ArrayIndexOf(this.keywords,d)?(f.push(new e(["",d])),b):-1};b.prototype.object=function(a,b,c){var f=this.subject(a,b,c);if(0<=f)return f;f=this.skipSpace(a,b);if(0>f)return-1;b=f;return'"'==
a.charAt(b)?(f='"""'==g(a,b,b+3)?'"""':'"',b+=f.length,a=this.strconst(a,b,f),f=a[0],c.push(this._store.literal(a[1])),f):-1};b.prototype.nodeOrLiteral=function(b,c,f){var d=this.node(b,c,f);if(0<=d)return d;d=this.skipSpace(b,c);if(0>d)return-1;c=d;d=b.charAt(c);if(0<="-+0987654321".indexOf(d)){q.lastIndex=0;var e=q.exec(b.slice(c));if(null!=e){var k=e[0],d=c+k.length;0<=k.indexOf("T")?f.push(this._store.literal(k,void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#dateTime"))):f.push(this._store.literal(k,
void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#date")))}else{p.lastIndex=0;e=p.exec(b.slice(c));if(null==e)throw a(this._thisDoc,this.lines,b,c,"Bad number or date syntax");d=c+p.lastIndex;k=g(b,c,d);0<=k.indexOf("e")?f.push(this._store.literal(parseFloat(k),void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#double"))):0<=g(b,c,d).indexOf(".")?f.push(this._store.literal(parseFloat(k),void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#decimal"))):f.push(this._store.literal(parseInt(k),
void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#integer")))}return d}if('"'==b.charAt(c)){d='"""'==g(b,c,c+3)?'"""':'"';c+=d.length;var k=null,l=this.strconst(b,c,d),d=l[0],l=l[1],e=null;if("@"==g(b,d,d+1)){v.lastIndex=0;e=v.exec(b.slice(d+1));if(null==e)throw a(this._thisDoc,startline,b,c,"Bad language code syntax on string literal, after @");c=v.lastIndex+d+1;e=g(b,d+1,c);d=c}"^^"==g(b,d,d+2)&&(c=new h([]),d=this.uri_ref2(b,d+2,c),k=c[0]);f.push(this._store.literal(l,e,k));return d}return-1};
b.prototype.strconst=function(b,c,f){for(var d=c,k="",h=this.lines;d<b.length;){c=d+f.length;if(g(b,d,c)==f)return new e([c,k]);if('"'==b.charAt(d))k+='"',d+=1;else{u.lastIndex=0;if(!u.exec(b.slice(d)))throw a(this._thisDoc,h,b,d,"Closing quote missing in string at ^ in "+g(b,d-20,d)+"^"+g(b,d,d+20));c=d+u.lastIndex-1;var k=k+g(b,d,c),l=b.charAt(c);if('"'==l)d=c;else if("\r"==l)d=c+1;else if("\n"==l){if('"'==f)throw a(this._thisDoc,h,b,c,"newline found in string literal");this.lines+=1;k+=l;d=c+1;
this.previousLine=this.startOfLine;this.startOfLine=d}else if("\\"==l){d=c+1;l=g(b,d,d+1);if(!l)throw a(this._thisDoc,h,b,c,"unterminated string literal (2)");var m='abfrtvn\\"'.indexOf(l);if(0<=m)l='a\b\f\r\t\v\n\\"'.charAt(m),k+=l,d+=1;else if("u"==l)l=this.uEscape(b,d+1,h),d=l[0],l=l[1],k+=l;else if("U"==l)l=this.UEscape(b,d+1,h),d=l[0],l=l[1],k+=l;else throw a(this._thisDoc,this.lines,b,c,"bad escape");}}}throw a(this._thisDoc,this.lines,b,c,"unterminated string literal");};b.prototype.uEscape=
function(b,c,f){for(var d=c,k=0,h=0;4>k;){var l=g(b,d,d+1).toLowerCase(),d=d+1;if(""==l)throw a(this._thisDoc,f,b,c,"unterminated string literal(3)");l="0123456789abcdef".indexOf(l);if(0>l)throw a(this._thisDoc,f,b,c,"bad string literal hex escape");h=16*h+l;k+=1}b=String.fromCharCode(h);return new e([d,b])};b.prototype.UEscape=function(b,c,f){for(var d=c,k=0,h="\\U";8>k;){var l=g(b,d,d+1).toLowerCase(),d=d+1;if(""==l)throw a(this._thisDoc,f,b,c,"unterminated string literal(3)");if(0>"0123456789abcdef".indexOf(l))throw a(this._thisDoc,
f,b,c,"bad string literal hex escape");h+=l;k+=1}b="0x"+g(h,2,10)-0;b=String.fromCharCode(b);return new e([d,b])};return function(a,c,f,d,g,e,k,h){return new b(a,c,f,d,g,e,k,h)}}();c.IndexedFormula=function(){c.Literal.prototype.hashString=c.Literal.prototype.toNT;c.Symbol.prototype.hashString=c.Symbol.prototype.toNT;c.BlankNode.prototype.hashString=c.BlankNode.prototype.toNT;c.Collection.prototype.hashString=c.Collection.prototype.toNT;c.IndexedFormula=function(b){function a(a,b,c,f){c=a.any(void 0,
c,f);if(void 0==c)return!1;a.equate(c,b);return!0}function f(a,b,c,f){b=a.any(b,c,void 0);if(void 0==b)return!1;a.equate(b,f);return!0}this.statements=[];this.optional=[];this.propertyActions=[];this.classActions=[];this.redirections=[];this.aliases=[];this.HTTPRedirects=[];this.subjectIndex=[];this.predicateIndex=[];this.objectIndex=[];this.whyIndex=[];this.index=[this.subjectIndex,this.predicateIndex,this.objectIndex,this.whyIndex];this.namespaces={};void 0===b&&(b=["sameAs","InverseFunctionalProperty",
"FunctionalProperty"]);this.propertyActions["<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>"]=[function(a,b,c,f,k){void 0!=a.typeCallback&&a.typeCallback(a,f,k);var l=a.classActions[f.hashString()],m=!1;if(l)for(var p=0;p<l.length;p++)m=m||l[p](a,b,c,f,k);return m}];0<=c.Util.ArrayIndexOf(b,"sameAs")&&(this.propertyActions["<http://www.w3.org/2002/07/owl#sameAs>"]=[function(a,b,c,f,k){a.equate(b,f);return!0}]);0<=c.Util.ArrayIndexOf(b,"InverseFunctionalProperty")&&(this.classActions["<http://www.w3.org/2002/07/owl#InverseFunctionalProperty>"]=
[function(b,c,f,g,k){return b.newPropertyAction(c,a)}]);0<=c.Util.ArrayIndexOf(b,"FunctionalProperty")&&(this.classActions["<http://www.w3.org/2002/07/owl#FunctionalProperty>"]=[function(a,b,c,g,k){return a.newPropertyAction(b,f)}])};c.IndexedFormula.prototype=new c.Formula;c.IndexedFormula.prototype.constructor=c.IndexedFormula;c.IndexedFormula.SuperClass=c.Formula;c.IndexedFormula.prototype.newPropertyAction=function(b,a){var c=b.hashString();void 0==this.propertyActions[c]&&(this.propertyActions[c]=
[]);this.propertyActions[c].push(a);for(var c=this.statementsMatching(void 0,b,void 0),e=!1,h=0;h<c.length;h++)e=e||a(this,c[h].subject,b,c[h].object);return e};c.IndexedFormula.prototype.setPrefixForURI=function(b,a){"tab"==b&&this.namespaces.tab||"ns"!==b.slice(0,2)&&"default"!==b.slice(0,7)&&(this.namespaces[b]=a)};c.IndexedFormula.prototype.register=function(b,a){this.namespaces[b]=a};c.IndexedFormula.prototype.equate=function(b,a){b=this.canon(b);a=this.canon(a);var c=b.compareTerm(a);return c?
0>c?this.replaceWith(a,b):this.replaceWith(b,a):!0};c.IndexedFormula.prototype.replaceWith=function(b,a){for(var c=b.hashString(),e=a.hashString(),h=function(a){var b=a[c];if(void 0!=b){var d=a[e];a[e]=void 0==d?b:b.concat(d);delete a[c]}},d=0;4>d;d++)h(this.index[d]);this.redirections[c]=a;if(b.uri){void 0==this.aliases[e]&&(this.aliases[e]=[]);this.aliases[e].push(b);if(this.aliases[c])for(d=0;d<this.aliases[c].length;d++)this.redirections[this.aliases[c][d].hashString()]=a,this.aliases[e].push(this.aliases[c][d]);
this.add(a,this.sym("http://www.w3.org/2007/ont/link#uri"),b.uri);this.sf&&this.sf.nowKnownAs(b,a)}h(this.classActions);h(this.propertyActions);return!0};c.IndexedFormula.prototype.canon=function(b){if(void 0==b)return b;var a=this.redirections[b.hashString()];return void 0==a?b:a};c.IndexedFormula.prototype.sameThings=function(b,a){if(b.sameTerm(a))return!0;var c=this.canon(b);if(void 0==c)return!1;var e=this.canon(a);return void 0==e?!1:c.uri==e.uri};c.IndexedFormula.prototype.uris=function(b){var a=
this.canon(b);b=this.aliases[a.hashString()];if(!a.uri)return[];a=[a.uri];if(void 0!=b)for(var c=0;c<b.length;c++)a.push(b[c].uri);return a};c.IndexedFormula.prototype.add=function(b,a,f,e){var h;void 0==e&&(e=this.fetcher?this.fetcher.appNode:this.sym("chrome:theSession"));b=c.term(b);a=c.term(a);f=c.term(f);e=c.term(e);void 0!=this.predicateCallback&&this.predicateCallback(this,a,e);var d=this.canon(a).hashString();h=this.propertyActions[d];var g=!1;if(h)for(var k=0;k<h.length;k++)g=g||h[k](this,
b,a,f,e);h=[this.canon(b).hashString(),d,this.canon(f).hashString(),this.canon(e).hashString()];b=new c.Statement(b,a,f,e);for(k=0;4>k;k++)a=this.index[k],f=h[k],void 0==a[f]&&(a[f]=[]),a[f].push(b);this.statements.push(b);return b};c.IndexedFormula.prototype.mentionsURI=function(b){b="<"+b+">";return!!this.subjectIndex[b]||!!this.objectIndex[b]||!!this.predicateIndex[b]};c.IndexedFormula.prototype.nextSymbol=function(b){for(var a=0;;a++){var c=b.uri+"#n"+a;if(!this.mentionsURI(c))return this.sym(c)}};
c.IndexedFormula.prototype.anyStatementMatching=function(b,a,c,e){return(b=this.statementsMatching(b,a,c,e,!0))&&b!=[]?b[0]:void 0};c.IndexedFormula.prototype.statementsMatching=function(b,a,f,e,h){f=[b,a,f,e];b=[];var d=[],g=[];e=[];for(a=0;4>a;a++)b[a]=this.canon(c.term(f[a])),void 0==b[a]?g.push(a):(e.push(a),d[a]=b[a].hashString());if(0==e.length)return this.statements;if(1==e.length)return a=e[0],(a=this.index[a][d[a]])&&h&&1<a.length&&(a=a.slice(0,1)),void 0==a?[]:a;var g=1E10,k;for(f=0;f<e.length;f++){a=
e[f];a=this.index[a][d[a]];if(void 0==a)return[];a.length<g&&(g=a.length,k=f)}a=e[k];d=this.index[a][d[a]];k=e.slice(0,k).concat(e.slice(k+1));e=[];for(var g=["subject","predicate","object","why"],l=0;l<d.length;l++){var m=d[l];for(f=0;f<k.length;f++)if(a=k[f],!this.canon(m[g[a]]).sameTerm(b[a])){m=null;break}if(null!=m&&(e.push(m),h))break}return e};c.IndexedFormula.prototype.remove=function(b){for(var a=[b.subject,b.predicate,b.object,b.why],f=0;4>f;f++){var e=this.canon(a[f]).hashString();void 0!=
this.index[f][e]&&c.Util.RDFArrayRemove(this.index[f][e],b)}c.Util.RDFArrayRemove(this.statements,b)};c.IndexedFormula.prototype.checkStatementList=function(b,a){for(var c=" found in "+["subject","predicate","object","why"][a]+" index.",e=0;e<b.length;e++){st=b[e];for(var h=[st.subject,st.predicate,st.object,st.why],d=function(a,b){for(var c=0;c<a.length;c++)if(a[c].subject.sameTerm(b.subject)&&a[c].predicate.sameTerm(b.predicate)&&a[c].object.sameTerm(b.object)&&a[c].why.sameTerm(b.why))return!0},
g=0;4>g;g++){var k=this.canon(h[g]).hashString();if(void 0==this.index[g][k])throw Error("No "+name[g]+" index for statement "+st+"@"+st.why+c);if(!d(this.index[g][k],st))throw Error("Index for "+name[g]+" does not have statement "+st+"@"+st.why+c);}if(!d(this.statements,st))throw Error("Statement list does not statement "+st+"@"+st.why+c);}};c.IndexedFormula.prototype.check=function(){this.checkStatementList(this.statements);for(var b=0;4>b;b++){var a=this.index[b],c;for(c in a)a.hasOwnProperty(c)&&
this.checkStatementList(a[c],b)}};c.IndexedFormula.prototype.removeMany=function(b,a,c,e,h){b=this.statementsMatching(b,a,c,e,!1);a=[];for(c=0;c<b.length;c++)a.push(b[c]);h&&(a=a.slice(0,h));for(c=0;c<a.length;c++)this.remove(a[c])};c.IndexedFormula.prototype.copyTo=function(b,a,f){f||(f=[]);var e=this.statementsMatching(b);-1!=c.Util.ArrayIndexOf(f,"two-direction")&&e.concat(this.statementsMatching(void 0,void 0,b));for(b=0;b<e.length;b++){var h=e[b];switch(h.object.termType){case "symbol":this.add(a,
h.predicate,h.object);break;case "literal":case "bnode":case "collection":this.add(a,h.predicate,h.object.copy(this))}-1!=c.Util.ArrayIndexOf(f,"delete")&&this.remove(h)}};c.Literal.prototype.copy=function(){return new c.Literal(this.value,this.lang,this.datatype)};c.BlankNode.prototype.copy=function(b){var a=new c.BlankNode;b.copyTo(this,a);return a};c.IndexedFormula.prototype.newUniversal=function(b){b=this.sym(b);this._universalVariables||(this._universalVariables=[]);this._universalVariables.push(b);
return b};c.IndexedFormula.prototype.newExistential=function(b){if(!b)return this.bnode();b=this.sym(b);return this.declareExistential(b)};c.IndexedFormula.prototype.declareExistential=function(b){this._existentialVariables||(this._existentialVariables=[]);this._existentialVariables.push(b);return b};c.IndexedFormula.prototype.formula=function(b){return new c.IndexedFormula(b)};c.IndexedFormula.prototype.close=function(){return this};c.IndexedFormula.prototype.hashString=c.IndexedFormula.prototype.toNT;
return c.IndexedFormula}();c.sparqlUpdateParser=function(b,a,f){var e,h,d=["INSERT","DELETE","WHERE"],g=c.Namespace("http://www.w3.org/ns/pim/patch#"),k=c.N3Parser(a,a,f,f,null,null,"",null),l={},m=function(a,b,c,d,f){return"Line "+(b+1)+" of <"+a+">: Bad syntax:\n   "+f+'\n   at: "'+c.slice(d,d+30)+'"'};e=0;var p=a.sym(f+"#query");for(l.query=p;;){f=k.skipSpace(b,e);if(0>f)return l;if(";"===b[f]){e=k.skipSpace(b,f+1);if(0>e)return l;f=e}var q=!1;for(h=0;h<d.length;h++){var u=d[h];if(b.slice(f,f+
u.length)===u){e=k.skipSpace(b,f+u.length);if(0>e)throw m(k._thisDoc,k.lines,b,f+u.length,"found EOF, needed {...} after "+u);if(("INSERT"===u||"DELETE"===u)&&"DATA"===b.slice(e,e+4)){f=k.skipSpace(b,e+4);if(0>f)throw m(k._thisDoc,k.lines,b,e+4,"needed {...} after INSERT DATA "+u);e=f}q=[];f=k.node(b,e,q);if(0>f)throw m(k._thisDoc,k.lines,b,e,"bad syntax or EOF in {...} after "+u);l[u.toLowerCase()]=q[0];a.add(p,g(u.toLowerCase()),q[0]);q=!0;e=f}}if(!q&&"@prefix"===b.slice(f,f+7)){e=k.directive(b,
f);if(0>e)throw m(k._thisDoc,k.lines,b,e,"bad syntax or EOF after @prefix ");e=k.checkDot(b,e);q=!0}if(!q)throw m(k._thisDoc,k.lines,b,f,"Unknown syntax at start of statememt: '"+b.slice(f).slice(0,20)+"'");}};c.IndexedFormula.prototype.applyPatch=function(b,a,f){var e=this,h=function(c){if(b["delete"]){var g=b["delete"];d&&(g=g.substitute(d));var g=g.statements,k=[],g=g.map(function(b){var c=e.statementsMatching(b.subject,b.predicate,b.object,a);return 0===c.length?(k.push(b),null):c[0]});if(k.length)return f("Couldn't find to delete: "+
k[0]);g.map(function(a){e.remove(a)})}b.insert&&(g=b.insert,d&&(g=g.substitute(d)),g=g.statements,g.map(function(b){b.why=a;e.add(b.subject,b.predicate,b.object,b.why)}));c()},d=null;if(b.where){var g=new c.Query("patch");g.pat=b.where;g.pat.statements.map(function(b){b.why=a});var k=[];e.query(g,function(a){k.push(a)},e.fetcher,function(){if(0==k.length)return f("No match found to be patched:"+b.where);if(1<k.length)return f("Patch ambiguous. No patch done.");d=k[0];h(f)})}else h(f)};c.Query=function(b,
a){this.pat=new c.IndexedFormula;this.vars=[];this.name=b;this.id=a};c.QuerySource=function(){this.queries=[];this.listeners=[];this.addQuery=function(b){var a;if(null===b.name||""===b.name)b.name="Query #"+(this.queries.length+1);b.id=this.queries.length;this.queries.push(b);for(a=0;a<this.listeners.length;a++)null!==this.listeners[a]&&this.listeners[a].addQuery(b)};this.removeQuery=function(b){var a;for(a=0;a<this.listeners.length;a++)null!==this.listeners[a]&&this.listeners[a].removeQuery(b);null!==
this.queries[b.id]&&delete this.queries[b.id]};this.addListener=function(b){var a;this.listeners.push(b);for(a=0;a<this.queries.length;a++)null!==this.queries[a]&&b.addQuery(this.queries[a])};this.removeListener=function(b){var a;for(a=0;a<this.queries.length;a++)null!==this.queries[a]&&b.removeQuery(this.queries[a]);for(a=0;a<this.listeners.length;a++)this.listeners[a]===b&&delete this.listeners[a]}};c.Variable.prototype.isVar=1;c.BlankNode.prototype.isVar=1;c.BlankNode.prototype.isBlank=1;c.Symbol.prototype.isVar=
0;c.Literal.prototype.isVar=0;c.Formula.prototype.isVar=0;c.Collection.prototype.isVar=0;c.IndexedFormula.prototype.query=function(b,a,f,e){function h(a,b){return a.nvars!==b.nvars?a.nvars-b.nvars:a.index.length-b.index.length}var d=this;c.log.info("Query:"+b.pat+", fetcher="+f+"\n");c.log.error("@@@@ query.js 4: "+c.log.error);c.log.error("@@@@ query.js 5");var g=function(a){var b="",c;for(c in a)a.hasOwnProperty(c)&&(b+="    "+c+" -> "+a[c]);return b},k=function(a){var b="Bindings: ",c,d=a.length;
for(c=0;c<d;c++)b+=g(a[c][0])+";\n\t";return b},l=function(a,b,c,d){var f;if(a.length!==b.length)return[];if(!a.length)return[[[],null]];var g;a:{g=a[0];var e=b[0],k=c[g];if(void 0===k){if(g.isVar){k=[];k[g]=e;g=[[k,null]];break a}k=g}if(k.complexType)if(g instanceof Array)g=e instanceof Array?l(g,e,c):[];else throw"query.js: oops - code not written yet";else d.redirections[k]&&(k=d.redirections[k]),d.redirections[e]&&(e=d.redirections[e]),g=k.sameTerm(e)?[[[],null]]:[]}if(0===g.length)return g;for(var e=
[],h=g.length,n,r,m,p,q,k=0;k<h;k++){n=g[k][0];f=[];for(p in n)n.hasOwnProperty(p)&&(f[p]=n[p]);for(p in c)c.hasOwnProperty(p)&&(f[p]=c[p]);f=l(a.slice(1),b.slice(1),f,d);m=f.length;for(r=0;r<m;r++){q=f[r][0];for(p in n)n.hasOwnProperty(p)&&(q[p]=n[p]);e.push([q,null])}}return e},m=function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c},p=function(a,b){this.trunkBindings=b;this.originalCallback=a;this.branches=[];return this};p.prototype.checkAllDone=
function(){var a;for(a=0;a<this.branches.length;a++)if(!this.branches[a].done)return;c.log.debug("OPTIONAL BIDNINGS ALL DONE:");this.doCallBacks(this.branches.length-1,this.trunkBindings)};p.prototype.doCallBacks=function(a,b){var c;if(0>a)return this.originalCallback(b);for(c=0;c<this.branches[a].results.length;c++)this.doCallBacks(a-1,m(b,this.branches[a].results[c]))};var q=function(a,b){this.count=0;this.done=this.success=!1;this.callback=a;this.onDone=b;return this};q.prototype.reportMatch=function(a){this.callback(a);
this.success=!0};q.prototype.reportDone=function(){this.done=!0;c.log.info("Mandatory query branch finished.***");if(void 0!==this.onDone)this.onDone()};var u=function(a){this.count=0;this.done=!1;this.results=[];this.junction=a;a.branches.push(this);return this};u.prototype.reportMatch=function(a){this.results.push(a)};u.prototype.reportDone=function(){c.log.debug("Optional branch finished - results.length = "+this.results.length);0===this.results.length&&(this.results.push({}),c.log.debug("Optional branch FAILED - that's OK."));
this.done=!0;this.junction.checkAllDone()};var v=0,r=function(b,f,e,k,h,l,n){c.log.debug("Match begins, Branch count now: "+n.count+" for "+n.pattern_debug);var m=null;void 0!==b.sf&&(m=b.sf);var q=f.statements;if(0===q.length){c.log.debug("FOUND MATCH WITH BINDINGS:"+g(e));if(0===f.optional.length)n.reportMatch(e);else{c.log.debug("OPTIONAL: "+f.optional);var q=new p(a,e),B=[],w;for(w=0;w<f.optional.length;w++)B[w]=new u(q),B[w].pattern_debug=f.optional[w];for(w=0;w<f.optional.length;w++)B[w].count+=
1,r(b,f.optional[w],e,"",h,a,B[w])}n.count--;c.log.debug("Match ends -- success , Branch count now: "+n.count+" for "+n.pattern_debug)}else{var F=q.length;if(h){var N="match"+v++,V=function(a,c){var g=a.uri;-1!==g.indexOf("#")&&(g=g.split("#")[0]);m&&m.addCallback("done",function(a){if(d.canon(d.sym(a)).uri!==g&&a!==d.canon(d.sym(g)))return!0;r(b,f,e,k,h,l,n);return!1});h(a,c)};for(w=0;w<F;w++){B=q[w];if(void 0!==e[B.subject]&&e[B.subject].uri&&m&&"unrequested"===m.getState(c.Util.uri.docpart(e[B.subject].uri))){V(e[B.subject],
N);return}if(void 0!==e[B.object]&&e[B.object].uri&&m&&"unrequested"===m.getState(c.Util.uri.docpart(e[B.object].uri))){V(e[B.object],N);return}}}A(b,f,e,k,h,l,n)}},A=function(a,b,d,f,e,n,m){var p=b.statements,q=p.length,u,w,F,B,v,A,D;for(u=0;u<q;u++){D=p[u];c.log.info("match2: item="+D+", bindingsSoFar="+g(d));var O=a;w=d;var H=void 0,P=F=void 0;A=v=void 0;D.nvars=0;D.index=null;F=[D.subject,D.predicate,D.object];A=[O.subjectIndex,O.predicateIndex,O.objectIndex];for(v=0;3>v;v++)F[v].isVar&&void 0===
w[F[v]]?D.nvars++:(H=F[v],P=w[H],H=void 0===P?H:P,O.redirections[H.hashString()]&&(H=O.redirections[H.hashString()]),P=A[v],D.index=P[H.hashString()],void 0===D.index&&(D.index=[]));null===D.index&&(D.index=O.statements)}p.sort(h);D=p[0];q=a.formula();q.optional=b.optional;q.constraints=b.constraints;q.statements=p.slice(1);c.log.debug(f+"match2 searching "+D.index.length+" for "+D+"; bindings so far="+g(d));u=D.index.length;for(p=O=0;p<u;p++)for(w=D.index[p],H=l([D.subject,D.predicate,D.object],
[w.subject,w.predicate,w.object],d,a),c.log.info(f+" From first: "+H.length+": "+k(H)),F=H.length,w=0;w<F;w++){v=[];var P=A=H[w][0],W=b.constraints,G=!0,C=void 0,X=void 0;for(C in P)P.hasOwnProperty(C)&&W[C]&&(X=W[C].test)&&!X(P[C])&&(G=!1);if(G){for(B in A)A.hasOwnProperty(B)&&(v[B]=A[B]);for(B in d)d.hasOwnProperty(B)&&(v[B]=d[B]);m.count++;O++;r(a,q,v,f+"  ",e,n,m)}else c.log.debug("Branch count CS: "+m.count)}m.count--;0===O&&c.log.debug("Match2 fails completely on "+D);c.log.debug("Match2 ends, Branch count: "+
m.count+" for "+m.pattern_debug);0===m.count&&(c.log.debug("Branch finished."),m.reportDone())};f||(f=function(a,b){null!==a&&c.Util.AJAR_handleNewTerm(d,a,b)});var B=this;c.log.debug("Query on "+this.statements.length);var n=new q(a,e);n.count++;setTimeout(function(){r(B,b.pat,b.pat.initBindings,"",f,a,n)},0)};c.queryToSPARQL=function(b){function a(a){var b="";a=a.statements;for(x in a)c.log.debug("Found statement: "+a),b+=h()+a[x]+"\n";return b}function f(a){var b="";for(K in a.constraints)var c=
a.constraints[K],b=b+(h()+"FILTER ( "+c.describe(K)+" ) \n");return b}function e(b){for(var k="",l=0;l<b.optional.length;l++)c.log.debug("Found optional query"),k+=h()+"OPTIONAL { \n",d++,k+=a(b.optional[l]),k+=f(b.optional[l]),k+=e(b.optional[l]),d--,k+=h()+"}\n";return k}function h(){var a="";for(i=0;i<d;i++)a+="    ";return a}var d=0;return function(b){var c=h()+"SELECT ";for(i=0;i<b.vars.length;i++)c+=b.vars[i]+" ";c+="\n";b=b.pat;var l=h()+"WHERE \n{ \n";d++;l+=a(b);l+=f(b);l+=e(b);d--;return c+
(l+"}")}(b)};c.SPARQLToQuery=function(b,a,f){function e(a){if(n[a])return n[a];var b=f.variable(a);return n[a]=b}function h(a){return"string"==typeof a&&a.match(/^[\?\$]/)}function d(a){return"string"==typeof a&&a.match(/^<[^>]*>$/)}function g(a){return d(a)?a.slice(1,a.length-1):a}function k(a){var b=-1==a.indexOf("'")?null:a.indexOf("'"),d=-1==a.indexOf('"')?null:a.indexOf('"');if(!b&&!d){var e=Array(1);e[0]=a;return e}e=Array(2);if(!b||d&&d<b)var h='"',b=d;else if(!d||b&&b<d)h="'";else return c.log.error("SQARQL QUERY OOPS!"),
e;e[0]=a.slice(0,b);h=a.slice(b+1).indexOf(h);if(-1==h)return c.log.error("SPARQL parsing error: no matching parentheses in literal "+a),a;a.slice(h+b+2).match(/^\^\^/)?(d=a.slice(h+b+2).indexOf(" "),e[1]=f.literal(a.slice(b+1,b+1+h),"",f.sym(g(a.slice(b+4+h,b+2+h+d)))),e=e.concat(k(a.slice(h+b+3+d)))):a.slice(h+b+2).match(/^@/)?(d=a.slice(h+b+2).indexOf(" "),e[1]=f.literal(a.slice(b+1,b+1+h),a.slice(b+3+h,b+2+h+d),null),e=e.concat(k(a.slice(h+b+2+d)))):(e[1]=f.literal(a.slice(b+1,b+1+h),"",null),
c.log.info("Literal found: "+e[1]),e=e.concat(k(a.slice(h+b+2))));return e}function l(a){a=a.replace(/\(/g," ( ").replace(/\)/g," ) ").replace(/</g," <").replace(/>/g,"> ").replace(/{/g," { ").replace(/}/g," } ").replace(/[\t\n\r]/g," ").replace(/; /g," ; ").replace(/\. /g," . ").replace(/, /g," , ");c.log.info("New str into spaceDelimit: \n"+a);var b=[];a=a.split(" ");for(x in a){var d=a[x];"string"==typeof d&&d.match(/[^ \n\t]/)&&(b=b.concat(a[x]))}return b}function m(a,b){for(i=0;i<b.length;i++)if("string"==
typeof b[i]&&b[i].toLowerCase()==a.toLowerCase())return i;return null}function p(a,b){var c=[];for(i=0;i<b.length;i++)"string"==typeof b[i]&&b[i].toLowerCase()==a.toLowerCase()&&c.push(i);return c}function q(a,b,d){c.log.info("Looking for a close bracket of type "+d+" in "+a);var f=0;for(i=0;i<a.length;i++)if(a[i]==b&&f++,a[i]==d&&f--,0>f)return i;c.log.error("Statement had no close parenthesis in SPARQL query");return 0}function u(a){this.describe=function(b){return b+" > "+a.toNT()};this.test=function(b){return b.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/)?
parseFloat(b.value)>parseFloat(a):b.toNT()>a.toNT()};return this}function v(a){this.describe=function(b){return b+" < "+a.toNT()};this.test=function(b){return b.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/)?parseFloat(b.value)<parseFloat(a):b.toNT()<a.toNT()};return this}function r(a){this.describe=function(b){return b+" = "+a.toNT()};this.test=function(b){return a.sameTerm(b)};return this}function A(a){this.describe=function(b){return"REGEXP( '"+a+"' , "+b+" )"};this.test=function(b){var c=
new RegExp(a);return b.value?c.test(b.value):!1}}function B(a,b){for(var k=[],l=0;l<a.length;l++)if("string"!=typeof a[l])k[l]=a[l];else{var n=l,t;t=a[l];t="string"==typeof t?t.replace(/^&lt;/,"<").replace(/&gt;$/,">"):t;a[n]=t;h(a[l])?k[l]=e(a[l].slice(1)):(n=a[l],"string"==typeof n&&(n.match(/^_:/)||n.match(/^$/))?(c.log.info(a[l]+" was identified as a bnode."),k[l]=f.bnode()):d(a[l])?(c.log.info(a[l]+" was identified as a symbol."),k[l]=f.sym(g(a[l]))):(n=a[l],"string"==typeof n&&n.match(/^:|^[^_][^:]*:/)?
(c.log.info(a[l]+" was identified as a prefixed symbol"),L[a[l].split(":")[0]]?k[l]=f.sym(a[l]=L[a[l].split(":")[0]]+a[l].split(":")[1]):(c.log.error("SPARQL error: "+a[l]+" with prefix "+a[l].split(":")[0]+" does not have a correct prefix entry."),k[l]=a[l])):k[l]=a[l]))}for(c.log.debug("WHERE: "+k);m("OPTIONAL",k);)opt=m("OPTIONAL",k),c.log.debug("OPT: "+opt+" "+k[opt]+" in "+k),"{"!=k[opt+1]&&c.log.warn("Bad optional opening bracket in word "+opt),l=q(k.slice(opt+2),"{","}"),-1==l?c.log.error("No matching bracket in word "+
opt):(l=k.slice(opt+2,opt+2+l),n=b,c.log.debug("Optional query: "+l+" not yet implemented."),t=f.formula(),B(l,t),n.optional.push(t),opt=m("OPTIONAL",k),l=q(k.slice(opt+2),"{","}"),k.splice(opt,l+3));for(c.log.debug("WHERE after optionals: "+k);m("FILTER",k);)(n=m("FILTER",k),"("!=k[n+1]&&c.log.warn("Bad filter opening bracket in word "+n),l=q(k.slice(n+2),"(",")"),-1==l)?c.log.error("No matching bracket in word "+n):(l=k.slice(n+2,n+2+l),n=b,3!=l.length||"variable"!=l[0].termType||"symbol"!=l[2].termType&&
"literal"!=l[2].termType?6==l.length&&"string"==typeof l[0]&&"regexp"==l[0].toLowerCase()&&"("==l[1]&&")"==l[5]&&","==l[3]&&"variable"==l[4].termType&&"literal"==l[2].termType&&(c.log.debug("Constraint added: "+l),n.constraints[l[4]]=new A(l[2].value)):"="==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new r(l[2])):">"==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new u(l[2])):"<"==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new v(l[2])):c.log.warn("I don't know how to handle the constraint: "+
l),n=m("FILTER",k),l=q(k.slice(n+2),"(",")"),k.splice(n,l+3));c.log.debug("WHERE after filters and optionals: "+k);l=Array(1);l[0]=-1;var w=l.concat(p(".",k)),n=[];for(t=0;t<w.length-1;t++)n[t]=k.slice(w[t]+1,w[t+1]);for(t in n){c.log.info("s+p+o "+t+" = "+n[t]);k=n[t][0];n[t].splice(0,1);var F=l.concat(p(";",n[t]));F.push(n[t].length);w=[];for(y=0;y<F.length-1;y++)w[y]=n[t].slice(F[y]+1,F[y+1]);for(t in w){c.log.info("p+o "+t+" = "+n[t]);F=w[t][0];w[t].splice(0,1);var N=l.concat(p(",",w[t]));N.push(w[t].length);
var E=[];for(y=0;y<N.length-1;y++)E[y]=w[t].slice(N[y]+1,N[y+1]);for(t in E)N=E[t][0],c.log.info("Subj="+k+" Pred="+F+" Obj="+N),b.add(k,F,N)}}}var n=[];c.log.info("SPARQL input: \n"+b);var t=new c.Query;b=function(a){a=k(a);var b=[];for(x in a)b="string"==typeof a[x]?b.concat(l(a[x])):b.concat(a[x]);a=b;for(b=0;b<a.length;b++)if("a"==a[b]&&(a[b]="<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>"),"is"==a[b]&&"of"==a[b+2]){a.splice(b,1);a.splice(b+1,1);var d=a[b-1];a[b-1]=a[b+1];a[b+1]=d}b=a;c.log.info("SPARQL Tokens: "+
b);return b}(b);var L=function(a){var b=p("PREFIX",a),f=[];for(i in b){var e=a[b[i]+1],k=a[b[i]+2];"string"==typeof e&&e.match(/:$/)?d(k)?(c.log.info("Prefix found: "+e+" -> "+k),e=e.split(":")[0],k=g(k),f[e]=k):c.log.error("Invalid SPARQL symbol: "+k):c.log.error("Invalid SPARQL prefix: "+e)}return f}(b);L.rdf||(L.rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#");L.rdfs||(L.rdfs="http://www.w3.org/2000/01/rdf-schema#");var U=m("SELECT",b),E=m("WHERE",b);if(0>U||0>E||U>E)return c.log.error("Invalid or nonexistent SELECT and WHERE tags in SPARQL query"),
!1;(function(a,b){c.log.info("SPARQL vars: "+a);for(x in a)if(h(a[x])){c.log.info("Added "+a[x]+" to query variables from SPARQL");var d=e(a[x].slice(1));b.vars.push(d);d.label=a[x].slice(1)}else c.log.warn("Incorrect SPARQL variable in SELECT: "+a[x])})(b.slice(U+1,E),t);B(b.slice(E+2,b.length-1),t.pat);if(a)return t;for(x in t.pat.statements)a=t.pat.statements[x],"symbol"==a.subject.termType&&c.sf&&c.sf.lookUpThing(a.subject,"sparql:"+a.subject),"symbol"==a.object.termType&&c.sf&&c.sf.lookUpThing(a.object,
"sparql:"+a.object);return t};c.SPARQLResultsInterpreter=function(b,a,f){function e(a){if(!a.name.match(/^xmlns/))return!1;var b=a.name.replace(/^xmlns/,"").replace(/^:/,"").replace(/ /g,"");k[b]=a.value;c.log.info("Prefix: "+b+"\nValue: "+a.value)}function h(a){if("string"==typeof a&&a.match(/^:|^[^_][^:]*:/)){var b;b=a.split(":")[0];a=a.split(":")[1]}else b="";if(k[b])return k[b]+a;c.log.error("Incorrect SPARQL results - bad prefix")}function d(a){for(var b=a.childNodes[0],d=0;d<a.childNodes.length;d++)if(3==
a.childNodes[d].nodeType){b=a.childNodes[d];break}if(h(a.nodeName)==q+"uri")return kb.sym(b.nodeValue);if(h(a.nodeName)==q+"literal")return kb.literal(b.nodeValue);if(h(a.nodeName)==q+"unbound")return"unbound";c.log.warn("Don't know how to handle xml binding term "+a);return!1}function g(b){for(var f=[],g=!1,e=0;e<b.childNodes.length;e++)if(1==b.childNodes[e].nodeType)if(h(b.childNodes[e].nodeName)!=q+"binding")c.log.warn("Bad binding node inside result");else{for(var g=b.childNodes[e],k=makeVar(g.getAttribute("name")),
m=null,p=0;p<g.childNodes.length;p++)if(1==g.childNodes[p].nodeType){m=d(g.childNodes[p]);break}if(!m)return c.log.warn("Bad binding"),!1;c.log.info("var: "+k+" binding: "+m);g=!0;"unbound"!=m&&(f[k]=m)}g&&a&&setTimeout(function(){a(f)},0);l.push(f)}var k=[],l=[],m,p;b=b.childNodes[0];var q="http://www.w3.org/2005/sparql-results#";k[""]="";if("sparql"==b.nodeName){for(var u=0;u<b.attributes.length;u++)e(b.attributes[u]);for(u=0;u<b.childNodes.length;u++)c.log.info("Type: "+b.childNodes[u].nodeType+
"\nName: "+b.childNodes[u].nodeName+"\nValue: "+b.childNodes[u].nodeValue),1==b.childNodes[u].nodeType&&h(b.childNodes[u].nodeName)==q+"head"?m=b.childNodes[u]:1==b.childNodes[u].nodeType&&h(b.childNodes[u].nodeName)==q+"results"&&(p=b.childNodes[u]);if(p||m){for(u=0;u<m.childNodes.length;u++)1==m.childNodes[u].nodeType&&h(m.childNodes[u].nodeName)==q+"variable"&&c.log.info("Var: "+m.childNodes[u].getAttribute("name"));for(u=0;u<p.childNodes.length;u++)h(p.childNodes[u].nodeName)==q+"result"&&(c.log.info("Result # "+
u),g(p.childNodes[u]));f&&f();return l}}c.log.error("Bad SPARQL results XML")};c.sparqlUpdate=function(){var b=function(a){this.store=a;this.ifps={};this.fps={};this.ns={};this.ns.link=c.Namespace("http://www.w3.org/2007/ont/link#");this.ns.http=c.Namespace("http://www.w3.org/2007/ont/http#");this.ns.httph=c.Namespace("http://www.w3.org/2007/ont/httph#");this.ns.rdf=c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.rdfs=c.Namespace("http://www.w3.org/2000/01/rdf-schema#");this.ns.rdf=
c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.owl=c.Namespace("http://www.w3.org/2002/07/owl#")};b.prototype.editable=function(a,b){if(!a)return!1;b||(b=tabulator.kb);if("file:///"==a.slice(0,8)){if(b.holds(b.sym(a),tabulator.ns.rdf("type"),tabulator.ns.link("MachineEditableDocument")))return"LOCALFILE";var e=b.statementsMatching(b.sym(a),void 0,void 0);tabulator.log.warn("sparql.editable: Not MachineEditableDocument file "+a+"\n");tabulator.log.warn(e.map(function(a){return a.toNT()}).join("\n"));
return!1}for(var h,e=!1,d=b.each(void 0,this.ns.link("requestedURI"),c.uri.docpart(a)),g=0;g<d.length;g++)if(h=d[g],void 0!==h){var k=b.any(h,this.ns.link("response"));if(void 0!==h){var l=b.each(k,this.ns.httph("ms-author-via"));if(l.length)for(h=0;h<l.length;h++){var m=l[h].value.trim();if(0<=m.indexOf("SPARQL"))return"SPARQL";if(0<=m.indexOf("DAV"))return"DAV"}k=b.each(k,this.ns.http("status"));if(k.length)for(h=0;h<k.length;h++)if(200==k[h]||404==k[h])e=!0}else tabulator.log.warn("sparql.editable: No response for "+
a+"\n")}if(0==d.length)tabulator.log.warn("sparql.editable: No request for "+a+"\n");else if(e)return!1;tabulator.log.warn("sparql.editable: inconclusive for "+a+"\n")};b.prototype.anonymize=function(a){return"_:"==a.toNT().substr(0,2)&&this._mentioned(a)?"?"+a.toNT().substr(2):a.toNT()};b.prototype.anonymizeNT=function(a){return this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+" ."};b.prototype._statement_bnodes=function(a){return[a.subject,a.predicate,a.object].filter(function(a){return a.isBlank})};
b.prototype._statement_array_bnodes=function(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(this._statement_bnodes(a[c]));b.sort();bnodes2=[];for(a=0;a<b.length;a++)0!=a&&b[a].sameTerm(b[a-1])||bnodes2.push(b[a]);return bnodes2};b.prototype._cache_ifps=function(){this.ifps={};for(var a=this.store.each(void 0,this.ns.rdf("type"),this.ns.owl("InverseFunctionalProperty")),b=0;b<a.length;b++)this.ifps[a[b].uri]=!0;this.fps={};a=this.store.each(void 0,this.ns.rdf("type"),this.ns.owl("FunctionalProperty"));
for(b=0;b<a.length;b++)this.fps[a[b].uri]=!0};b.prototype._bnode_context2=function(a,b,c){for(var h=this.store.statementsMatching(void 0,void 0,a,b),d=0;d<h.length;d++)if(this.fps[h[d].predicate.uri]){var g=h[d].subject;if(!g.isBlank)return[h[d]];if(c&&(g=this._bnode_context2(g,b,c-1),null!=g))return g.concat([h[d]])}h=this.store.statementsMatching(a,void 0,void 0,b);for(d=0;d<h.length;d++)if(this.ifps[h[d].predicate.uri]){g=h[d].object;if(!g.isBlank)return[h[d]];if(c&&(g=this._bnode_context2(g,b,
c-1),void 0!=g))return g.concat([h[d]])}return null};b.prototype._bnode_context_1=function(a,b){for(var c=0;3>c;c++){var h=this._bnode_context2(a,b,c);if(null!==h)return h}throw"Unable to uniquely identify bnode: "+a.toNT();};b.prototype._mentioned=function(a){return 0!==this.store.statementsMatching(a).length||0!==this.store.statementsMatching(void 0,a).length||0!==this.store.statementsMatching(void 0,void 0,a).length};b.prototype._bnode_context=function(a,b){var c=[];if(a.length){this._cache_ifps();
for(var h=0;h<a.length;h++){var d=a[h];this._mentioned(d)&&(c=c.concat(this._bnode_context_1(d,b)))}}return c};b.prototype._statement_context=function(a){var b=this._statement_bnodes(a);return this._bnode_context(b,a.why)};b.prototype._context_where=function(a){var b=this;return void 0==a||0==a.length?"":"WHERE { "+a.map(function(a){return b.anonymizeNT(a)}).join("\n")+" }\n"};b.prototype._fire=function(a,b,e){if(!a)throw"No URI given for remote editing operation: "+b;tabulator.log.info("sparql: sending update to <"+
a+">\n   query="+b+"\n");var h=c.Util.XMLHTTPFactory();h.onreadystatechange=function(){if(4==h.readyState){var c=!h.status||200<=h.status&&300>h.status;c?tabulator.log.debug("sparql: update Ok for <"+a+">"):tabulator.log.error("sparql: update failed for <"+a+"> status="+h.status+", "+h.statusText+", body length="+h.responseText.length+"\n   for query: "+b);e(a,c,h.responseText,h)}};if(!tabulator.isExtension)try{c.Util.enablePrivilege("UniversalBrowserRead")}catch(d){alert("Failed to get privileges: "+
d)}h.open("POST",a,!0);h.setRequestHeader("Content-type","application/sparql-update");h.send(b)};b.prototype.update_statement=function(a){if(!a||void 0!=a.why){var b=this,c=this._statement_context(a);return{statement:a?[a.subject,a.predicate,a.object,a.why]:void 0,statementNT:a?this.anonymizeNT(a):void 0,where:b._context_where(c),set_object:function(a,c){query=this.where;query+="DELETE DATA { "+this.statementNT+" } ;\n";query+="INSERT DATA { "+this.anonymize(this.statement[0])+" "+this.anonymize(this.statement[1])+
" "+this.anonymize(a)+"  . }\n";b._fire(this.statement[3].uri,query,c)}}}};b.prototype.insert_statement=function(a,b){var c=a instanceof Array?a[0]:a,h=this._context_where(this._statement_context(c));if(a instanceof Array){for(var d="",g=0;g<a.length;g++)d+=a[g]+"\n";h+="INSERT DATA { "+d+" }\n"}else h+="INSERT DATA { "+this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+"  . }\n";this._fire(c.why.uri,h,b)};b.prototype.delete_statement=function(a,b){var c=a instanceof
Array?a[0]:a,h=this._context_where(this._statement_context(c));if(a instanceof Array){for(var d="",g=0;g<a.length;g++)d+=a[g]+"\n";h+="DELETE DATA { "+d+" }\n"}else h+="DELETE DATA { "+this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+"  . }\n";this._fire(c.why.uri,h,b)};b.prototype.update=function(a,b,e){var h=this.store;tabulator.log.info("update called");var d=void 0==a?[]:a instanceof c.IndexedFormula?a.statements:a instanceof Array?a:[a],g=void 0==b?[]:b instanceof
c.IndexedFormula?b.statements:b instanceof Array?b:[b];if(!(d instanceof Array))throw"Type Error "+typeof d+": "+d;if(!(g instanceof Array))throw"Type Error "+typeof g+": "+g;if(0===d.length&&0===g.length)return e(null,!0);var k=d.length?d[0].why:g[0].why;d.map(function(a){if(!k.sameTerm(a.why))throw"sparql update: destination "+k+" inconsistent with ds "+a.why;});g.map(function(a){if(!k.sameTerm(a.why))throw"sparql update: destination = "+k+" inconsistent with st.why ="+a.why;});a=this.editable(k.uri,
h);if(!a)throw"Can't make changes in uneditable "+k;if(0<=a.indexOf("SPARQL")){var l=[];d.length&&(l=this._statement_array_bnodes(d));g.length&&(l=l.concat(this._statement_array_bnodes(g)));var l=this._bnode_context(l,k),m=this._context_where(l),p="";if(m.length){if(d.length){p+="DELETE { ";for(l=0;l<d.length;l++)p+=this.anonymizeNT(d[l])+"\n";p+=" }\n"}if(g.length){p+="INSERT { ";for(l=0;l<g.length;l++)p+=this.anonymizeNT(g[l])+"\n";p+=" }\n"}p+=m}else{if(d.length){p+="DELETE DATA { ";for(l=0;l<
d.length;l++)p+=this.anonymizeNT(d[l])+"\n";p+=" } \n"}if(g.length){d.length&&(p+=" ; ");p+="INSERT DATA { ";for(l=0;l<g.length;l++)p+=this.anonymizeNT(g[l])+"\n";p+=" }\n"}}this._fire(k.uri,p,function(a,b,c,f){tabulator.log.info("\t sparql: Return success="+b+" for query "+p+"\n");if(b){for(var l=0;l<d.length;l++)try{h.remove(d[l])}catch(n){e(a,!1,"sparqlUpdate: Remote OK but error deleting statemmnt "+d[l]+" from local store:\n"+n)}for(l=0;l<g.length;l++)h.add(g[l].subject,g[l].predicate,g[l].object,
k)}e(a,b,c,f)})}else if(0<=a.indexOf("DAV")){l=h.any(k,this.ns.link("request"));if(!l)throw"No record of our HTTP GET request for document: "+k;var q=h.any(l,this.ns.link("response"));if(!q)return null;for(var u=h.the(q,this.ns.httph("content-type")).value,v=h.statementsMatching(void 0,void 0,void 0,k).slice(),l=0;l<d.length;l++)c.Util.RDFArrayRemove(v,d[l]);for(l=0;l<g.length;l++)v.push(g[l]);var r=c.Serializer(h);r.suggestNamespaces(h.namespaces);r.setBase(k.uri);switch(u){case "application/rdf+xml":m=
r.statementsToXML(v);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":m=r.statementsToN3(v);break;default:throw"Content-type "+u+" not supported for data write";}(l=h.the(q,this.ns.httph("content-location")))&&(targetURI=c.uri.join(l.value,targetURI));var A=c.Util.XMLHTTPFactory();A.onreadystatechange=function(){if(4==A.readyState){var a=!A.status||200<=A.status&&300>A.status;if(a){for(var b=0;b<d.length;b++)h.remove(d[b]);for(b=0;b<g.length;b++)h.add(g[b].subject,
g[b].predicate,g[b].object,k)}e(k.uri,a,A.responseText)}};A.open("PUT",targetURI,!0);A.setRequestHeader("Content-type",u);A.send(m)}else if(0<=a.indexOf("LOCALFILE"))try{tabulator.log.info("Writing back to local file\n");v=h.statementsMatching(void 0,void 0,void 0,k).slice();for(l=0;l<d.length;l++)c.Util.RDFArrayRemove(v,d[l]);for(l=0;l<g.length;l++)v.push(g[l]);r=c.Serializer(h);r.suggestNamespaces(h.namespaces);r.setBase(k.uri);u=k.uri.lastIndexOf(".");if(1>u)throw"Rewriting file: No filename extension: "+
k.uri;q=k.uri.slice(u+1);switch(q){case "rdf":case "owl":case "xml":m=r.statementsToXML(v);break;case "n3":case "nt":case "ttl":m=r.statementsToN3(v);break;default:throw"File extension ."+q+" not supported for data write";}dump("Writing back: <<<"+m+">>>\n");var B=k.uri.slice(7),n=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);n.initWithPath(B);if(!n.exists())throw"Rewriting file <"+k.uri+"> but it does not exist!";var t=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
t.init(n,42,438,0);t.write(m,m.length);t.close();for(l=0;l<d.length;l++)h.remove(d[l]);for(l=0;l<g.length;l++)h.add(g[l].subject,g[l].predicate,g[l].object,k);e(k.uri,!0,"")}catch(L){e(k.uri,!1,"Exception trying to write back file <"+k.uri+">\n"+tabulator.Util.stackString(L))}else throw"Unhandled edit method: '"+a+"' for "+k;};b.prototype.put=function(a,b,e,h){var d=this.store;if("string"!==typeof b){var g=c.Serializer(d);g.suggestNamespaces(d.namespaces);g.setBase(a.uri);switch(e){case "application/rdf+xml":b=
g.statementsToXML(b);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":b=g.statementsToN3(b);break;default:throw"Content-type "+e+" not supported for data PUT";}}var k=c.Util.XMLHTTPFactory();k.onreadystatechange=function(){4==k.readyState&&h(a.uri,!k.status||200<=k.status&&300>k.status,k.responseText,k)};k.open("PUT",a.uri,!0);k.setRequestHeader("Content-type",e);k.send(b)};return b}();c.jsonParser=function(){return{parseJSON:function(b,a,c){var e,h,d={},g=
c.sym(a);for(x in b){0===x.indexOf("_:")?d[x]?a=d[x]:(a=c.bnode(x),d[x]=a):a=c.sym(x);var k=b[x];for(y in k){var l=k[y];e=c.sym(y);for(z in l){var m=l[z];if("uri"===m.type)h=c.sym(m.value),c.add(a,e,h,g);else if("bnode"===m.type)d[m.value]?h=d[m.value]:(h=c.bnode(m.value),d[m.value]=h),c.add(a,e,h,g);else if("literal"===m.type)h=m.datatype?c.literal(m.value,void 0,c.sym(m.datatype)):m.lang?c.literal(m.value,m.lang):c.literal(m.value),c.add(a,e,h,g);else throw"error: unexpected termtype: "+z.type;
}}}}}}();c.Serializer=function(){var b=function(a){this.flags="";this.base=null;this.prefixes=[];this.namespacesUsed=[];this.keywords=["a"];this.prefixchars="abcdefghijklmnopqustuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";this.incoming=null;this.formulas=[];this.store=a};b.prototype.setBase=function(a){this.base=a};b.prototype.setFlags=function(a){this.flags=a?a:""};b.prototype.toStr=function(a){var b=a.toNT();"formula"==a.termType&&(this.formulas[b]=a);return b};b.prototype.fromStr=function(a){if("{"==a[0]){var b=
this.formulas[a];b||alert("No formula object for "+a);return b}return this.store.fromNT(a)};b.prototype.suggestPrefix=function(a,b){"default"!==a.slice(0,7)&&"ns"!==a.slice(0,2)&&(this.prefixes[b]=a)};b.prototype.suggestNamespaces=function(a){for(var b in a)this.prefixes[a[b]]=b};b.prototype.makeUpPrefix=function(a){function c(g){if(h[g]||!b.prototype.validPrefix.test(g)||"ns"===g)return!1;d=this.prefixes[a]=g;return!0}var e=a,h=[],d,c=c.bind(this),g;for(g in this.prefixes)h[this.prefixes[g]]=g;0<=
"#/".indexOf(e[e.length-1])&&(e=e.slice(0,-1));g=e.lastIndexOf("/");0<=g&&(e=e.slice(g+1));for(g=0;g<e.length;)if(this.prefixchars.indexOf(e[g]))g++;else break;e=e.slice(0,g);if(6>e.length&&c(e)||c(e.slice(0,3))||c(e.slice(0,2))||c(e.slice(0,4))||c(e.slice(0,1))||c(e.slice(0,5)))return d;b.prototype.validPrefix.test(e)||(e="n");for(g=0;;g++)if(c(e.slice(0,3)+g))return d};b.prototype.rootSubjects=function(a){for(var b={},c={},h=0;h<a.length;h++){var d=a[h];[d.subject,d.predicate,d.object].map(function(a){"bnode"==
a.termType&&a.toNT()});var g=a[h].object;b.hasOwnProperty(g)||(b[g]=[]);b[g].push(d.subject);(g=c[this.toStr(d.subject)])||(g=[]);g.push(d);c[this.toStr(d.subject)]=g}a=[];for(var k in c)c.hasOwnProperty(k)&&(g=this.fromStr(k),"bnode"==g.termType&&b[g]&&1==b[g].length||a.push(g));this.incoming=b;k={};for(h=0;h<a.length;h++)k[a[h].toNT()]=!0;return{roots:a,subjects:c,rootsHash:k,incoming:b}};b.prototype.toN3=function(a){return this.statementsToN3(a.statements)};b.prototype._notQNameChars="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~";
b.prototype._notNameChars=b.prototype._notQNameChars+":";b.prototype.statementsToN3=function(a){function f(a){a=this.rootSubjects(a);for(var b=a.roots,c=[],d=0;d<b.length;d++)c.push(e(b[d],a));return c}function e(a,b){return"bnode"!=a.termType||b.incoming[a]?[g(a,b)].concat([h(a,b)]).concat(["."]):d(a,b,!0).concat(["."])}function h(a,b){var c=[],e=null,f=b.subjects[this.toStr(a)];if("undefined"==typeof f)throw"Cant find statements for "+a;f.sort();for(var k=[],h=0;h<f.length;h++){var m=f[h];m.predicate.uri==
e?k.push(","):(e&&(c=c.concat([k]).concat([";"]),k=[]),c.push(l[m.predicate.uri]?l[m.predicate.uri]:g(m.predicate,b)));e=m.predicate.uri;k.push(d(m.object,b))}return c=c.concat([k])}function d(a,b,c){return"bnode"==a.termType&&b.subjects[this.toStr(a)]&&(c||void 0==b.rootsHash[a.toNT()])?["["].concat(h(a,b)).concat(["]"]):g(a,b)}function g(a,b){switch(a.termType){case "formula":var c=["{"],c=c.concat(f(a.statements));return c.concat(["}"]);case "collection":c=["("];for(i=0;i<a.elements.length;i++)c.push([d(a.elements[i],
b)]);c.push(")");return c;default:return this.atomicTermToN3(a)}}function k(){var a="";this.defaultNamespace&&(a+="@prefix : <"+this.defaultNamespace+">.\n");for(var b in this.prefixes)this.prefixes.hasOwnProperty(b)&&this.namespacesUsed[b]&&(a+="@prefix "+this.prefixes[b]+": <"+c.uri.refTo(this.base,b)+">.\n");return a+"\n"}var l={"http://www.w3.org/2002/07/owl#sameAs":"=","http://www.w3.org/2000/10/swap/log#implies":"=>","http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"a"},m=function(a){for(var b=
"",c=0;c<a.length;c++){var d=a[c],d="string"==typeof d?d:m(d);0!=c&&","!=d&&";"!=d&&(b+=" ");b+=d}return b},p=function(a,b){var c="",d=1E5;b||(b=0);for(var g=0;g<a.length;g++){var e=a[g];if("string"!=typeof e){var f=p(e,b+1);if(f.length<10*(80-4*b)&&0>f.indexOf('"""')){var k=m(e);k.length<80-4*b&&(e="   "+k,f="")}f&&(d=1E4);c+=f}if("string"==typeof e){if("1"==e.length&&"\n"==c.slice(-1))if(0<=",.;".indexOf(e)){c=c.slice(0,-1)+e+"\n";d+=1;continue}else if(0<="])}".indexOf(e)){c=c.slice(0,-1)+" "+e+
"\n";d+=2;continue}if(d<4*b+4)c=c.slice(0,-1)+" "+e+"\n",d+=e.length+1;else{d="";for(f=0;f<4*b;f++)d+=" ";k=d+e;c+=k+"\n";d=k.length}}}return c},f=f.bind(this),h=h.bind(this),d=d.bind(this);b.prototype.termToN3=g;g=g.bind(this);k=k.bind(this);a=f(a);return k()+p(a,-1)};b.prototype.atomicTermToN3=function(a,b){switch(a.termType){case "bnode":case "variable":return a.toNT();case "literal":if(a.datatype)switch(a.datatype.uri){case "http://www.w3.org/2001/XMLSchema#integer":return a.value.toString();
case "http://www.w3.org/2001/XMLSchema#boolean":return a.value?"true":"false"}var c=this.stringToN3(a.value);a.lang&&(c+="@"+a.lang);a.datatype&&(c+="^^"+this.termToN3(a.datatype,b));return c;case "symbol":return this.symbolToN3(a);default:throw"Internal: atomicTermToN3 cannot handle "+a+" of termType+"+a.termType;}};b.prototype.validPrefix=new RegExp(/^[a-zA-Z][a-zA-Z0-9]*$/);b.prototype.forbidden1=new RegExp(/[\\"\b\f\r\v\t\n\u0080-\uffff]/gm);b.prototype.forbidden3=new RegExp(/[\\"\b\f\r\v\u0080-\uffff]/gm);
b.prototype.stringToN3=function(a,c){c||(c="e");var e="",h=0,d=0,g,k;20<a.length&&'"'!=a.slice(-1)&&0>c.indexOf("n")&&(0<a.indexOf("\n")||0<a.indexOf('"'))?(g='"""',k=b.prototype.forbidden3):(g='"',k=b.prototype.forbidden1);for(h=0;h<a.length;){k.lastIndex=0;if(null==k.exec(a.slice(h)))break;d=h+k.lastIndex-1;e+=a.slice(h,d);h=a[d];if('"'==h&&'"""'==g&&'"""'!=a.slice(d,d+3))e+=h;else var l='\b\f\r\t\v\n\\"'.indexOf(h),e=0<=l?e+("\\"+'bfrtvn\\"'[l]):0<=c.indexOf("e")?e+("\\u"+("000"+h.charCodeAt(0).toString(16).toLowerCase()).slice(-4)):
e+h;h=d+1}return g+e+a.slice(h)+g};b.prototype.symbolToN3=function(a){a=a.uri;var f=a.indexOf("#");0>f&&0>this.flags.indexOf("/")&&(f=a.lastIndexOf("/"));if(0<=f&&0>this.flags.indexOf("p")){for(var e=!0,h=f+1;h<a.length;h++)if(0<=b.prototype._notNameChars.indexOf(a[h])){e=!1;break}if(a.slice(0,f)==this.base)return"<#"+a.slice(f+1)+">";if(e){e=a.slice(f+1);f=a.slice(0,f+1);if(this.defaultNamespace&&this.defaultNamespace==f&&0>this.flags.indexOf("d"))return 0<=this.flags.indexOf("k")&&0>this.keyords.indexOf(e)?
e:":"+e;(h=this.prefixes[f])||(h=this.makeUpPrefix(f));if(h)return this.namespacesUsed[f]=!0,h+":"+e}}if(0>this.flags.indexOf("r")&&this.base)a=c.uri.refTo(this.base,a);else if(0<=this.flags.indexOf("u")){f="";for(h=0;h<a.length;h++)e=a.charCodeAt(h),f=65535<e?f+("\\U"+("00000000"+e.toString(16)).slice(-8)):126<e?f+("\\u"+("0000"+e.toString(16)).slice(-4)):f+a[h];a=f}else a=encodeURI(a);return"<"+a+">"};b.prototype.writeStore=function(a){var b=this.store,c=b.fetcher,c=c&&c.appNode,h=b.statementsMatching(void 0,
b.sym("http://www.w3.org/2007/ont/link#requestedURI")).map(function(a){return a.subject});c&&h.push(c);var d=[];h.map(function(a){d=d.concat(b.statementsMatching(void 0,void 0,void 0,a))});a(this.statementsToN3(d));h=this.store.index[3];for(s in h)h=b.fromNT(s),c&&h.sameTerm(c)||a("\n"+this.atomicTermToN3(h)+" "+this.atomicTermToN3(b.sym("http://www.w3.org/2000/10/swap/log#"))+" { "+this.statementsToN3(b.statementsMatching(void 0,void 0,void 0,h))+" }.\n")};b.prototype.statementsToXML=function(a){function f(a){this.suggestPrefix("rdf",
"http://www.w3.org/1999/02/22-rdf-syntax-ns#");a=this.rootSubjects(a);for(var b=a.roots,c=[],g=0;g<b.length;g++)Q=b[g],c.push(d(Q,a));return c}function e(a){return"undefined"==typeof a?"@@@undefined@@@@":a.replace(/[&<"]/g,function(a){switch(a[0]){case "&":return"&amp;";case "<":return"&lt;";case '"':return"&quot;"}})}function h(a){return e(this.base?c.Util.uri.refTo(this.base,a.uri):a.uri)}function d(a,b){var f=[],k,m,p,q=b.subjects[this.toStr(a)];if("undefined"==typeof q)throw"Serializing XML - Cant find statements for "+
a;q.sort(function(a,b){var c=a.predicate.uri,d=b.predicate.uri;if("http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==c.substring(0,44)||"http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==d.substring(0,44))return c.localeCompare(d);var g=c.substring(44),e=d.substring(44),f=parseInt(g),k=parseInt(e);return isNaN(f)||isNaN(k)||f!=g||k!=e?c.localeCompare(d):f-k});for(var u=0;u<q.length;u++)if(p=q[u],"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"!=p.predicate.uri||k||"symbol"!=p.object.termType){m=p.predicate;
if("http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==m.uri.substr(0,44)){var v=m.uri.substr(44),C=parseInt(v);v==C.toString()&&(m=new c.Symbol("http://www.w3.org/1999/02/22-rdf-syntax-ns#li"))}m=l(m);switch(p.object.termType){case "bnode":f=1==b.incoming[p.object].length?f.concat(["<"+m+">",d(p.object,b),"</"+m+">"]):f.concat(["<"+m+' rdf:nodeID="'+p.object.toNT().slice(2)+'"/>']);break;case "symbol":f=f.concat(["<"+m+' rdf:resource="'+h(p.object)+'"/>']);break;case "literal":f=f.concat(["<"+m+(p.object.dt?
' rdf:datatype="'+e(p.object.dt.uri)+'"':"")+(p.object.lang?' xml:lang="'+p.object.lang+'"':"")+">"+e(p.object.value)+"</"+m+">"]);break;case "collection":f=f.concat(["<"+m+' rdf:parseType="Collection">',g(p.object,b),"</"+m+">"]);break;default:throw"Can't serialize object of type "+p.object.termType+" into XML";}}else k=p.object;k=k?l(k):"rdf:Description";p="";"bnode"==a.termType?b.incoming[a]&&1==b.incoming[a].length||(p=' rdf:nodeID="'+a.toNT().slice(2)+'"'):p=' rdf:about="'+h(a)+'"';return["<"+
k+p+">"].concat([f]).concat(["</"+k+">"])}function g(a,b){for(var c=[],g=0;g<a.elements.length;g++)c.push(d(a.elements[g],b));return c}function k(a,b){var c=[],d=b.subjects[this.toStr(a)];if(void 0==d)return c;d.sort();for(var f=0;f<d.length;f++){var m=d[f];switch(m.object.termType){case "bnode":c=b.rootsHash[m.object.toNT()]?c.concat(["<"+l(m.predicate)+' rdf:nodeID="'+m.object.toNT().slice(2)+'">',"</"+l(m.predicate)+">"]):c.concat(["<"+l(m.predicate)+' rdf:parseType="Resource">',k(m.object,b),
"</"+l(m.predicate)+">"]);break;case "symbol":c=c.concat(["<"+l(m.predicate)+' rdf:resource="'+h(m.object)+'"/>']);break;case "literal":c=c.concat(["<"+l(m.predicate)+(m.object.datatype?' rdf:datatype="'+e(m.object.datatype.uri)+'"':"")+(m.object.lang?' xml:lang="'+m.object.lang+'"':"")+">"+e(m.object.value)+"</"+l(m.predicate)+">"]);break;case "collection":c=c.concat(["<"+l(m.predicate)+' rdf:parseType="Collection">',g(m.object,b),"</"+l(m.predicate)+">"]);break;default:throw"Can't serialize object of type "+
m.object.termType+" into XML";}}return c}function l(a){var c=a.uri,d=c.indexOf("#");0>d&&0>this.flags.indexOf("/")&&(d=c.lastIndexOf("/"));if(0>d)throw"Cannot make qname out of <"+c+">";for(a=d+1;a<c.length;a++)if(0<=b.prototype._notNameChars.indexOf(c[a]))throw'Invalid character "'+c[a]+'" cannot be in XML qname for URI: '+c;a=c.slice(d+1);c=c.slice(0,d+1);if(this.defaultNamespace&&this.defaultNamespace==c&&0>this.flags.indexOf("d"))return a;(d=this.prefixes[c])||(d=this.makeUpPrefix(c));m[c]=!0;
return d+":"+a}var m=[];m["http://www.w3.org/1999/02/22-rdf-syntax-ns#"]=!0;var p=function(a){for(var b="",c=0;c<a.length;c++)var d=a[c],d="string"==typeof d?d:p(d),b=b+d;return b},q=function(a,b){var c="",d=1E5;b||(b=0);for(var g=0;g<a.length;g++){var e=a[g];if("string"!=typeof e){var f=q(e,b+1);if(f.length<10*(80-4*b)&&0>f.indexOf('"""')){var k=p(e);k.length<80-4*b&&(e="   "+k,f="")}f&&(d=1E4);c+=f}if("string"==typeof e)if(d<4*b+4)c=c.slice(0,-1)+" "+e+"\n",d+=e.length+1;else{d="";for(f=0;f<4*b;f++)d+=
" ";k=d+e;c+=k+"\n";d=k.length}}return c},f=f.bind(this),h=h.bind(this),d=d.bind(this),k=k.bind(this),l=l.bind(this);a=f(a);var u="<rdf:RDF";this.defaultNamespace&&(u+=' xmlns="'+e(this.defaultNamespace)+'"');for(var v in m)m.hasOwnProperty(v)&&(u+="\n xmlns:"+this.prefixes[v]+'="'+e(v)+'"');return q([u+">",a,"</rdf:RDF>"],-1)};return function(a){return new b(a)}}();var J=function(b,a){return function(){return b.apply(a,arguments)}},C={}.hasOwnProperty;if("undefined"===typeof c||null===c)c={};c.UpdatesSocket=
function(){function b(a,b){this.parent=a;this.via=b;this.subscribe=J(this.subscribe,this);this.onError=J(this.onError,this);this.onMessage=J(this.onMessage,this);this.onClose=J(this.onClose,this);this.onOpen=J(this.onOpen,this);this._subscribe=J(this._subscribe,this);this._send=J(this._send,this);this.connected=!1;this.pending={};this.subscribed={};this.socket={};try{this.socket=new WebSocket(b),this.socket.onopen=this.onOpen,this.socket.onclose=this.onClose,this.socket.onmessage=this.onMessage,this.socket.onerror=
this.onError}catch(c){this.onError(c)}}b.prototype._decode=function(a){var b,c,h,d;h={};var g,k;k=a.split("&");a=[];d=0;for(g=k.length;d<g;d++)b=k[d],a.push(b.split("="));for(c in a)b=a[c],d=[decodeURIComponent(b[0]),decodeURIComponent(b[1])],b=d[0],d=d[1],null==h[b]&&(h[b]=[]),h[b].push(d);return h};b.prototype._send=function(a,b,c){var h;a=[a,b,c].join(" ");return"function"===typeof(h=this.socket).send?h.send(a):void 0};b.prototype._subscribe=function(a){this._send("sub",a,"");return this.subscribed[a]=
!0};b.prototype.onOpen=function(a){var b;this.connected=!0;a=[];for(b in this.pending)delete this.pending[b],a.push(this._subscribe(b));return a};b.prototype.onClose=function(a){var b;this.connected=!1;for(b in this.subscribed)this.pending[b]=!0;return this.subscribed={}};b.prototype.onMessage=function(a){var b;a=a.data.split(" ");if("ping"===a[0])return"function"===typeof(b=this.socket).send?b.send("pong "+a.slice(1).join(" ")):void 0;if("pub"===a[0])return this.parent.onUpdate(a[1],this._decode(a[2]))};
b.prototype.onError=function(a){throw"onError"+a;};b.prototype.subscribe=function(a){return this.connected?this._subscribe(a):this.pending[a]=!0};return b}();c.UpdatesVia=function(){function b(a){this.fetcher=a;this.onUpdate=J(this.onUpdate,this);this.onHeaders=J(this.onHeaders,this);this.register=J(this.register,this);this.graph={};this.via={}}b.prototype.register=function(a,b){null==this.via[a]&&(this.via[a]=new c.UpdatesSocket(this,a));return this.via[a].subscribe(b)};b.prototype.onHeaders=function(a){var b,
c;if(null==a.headers||"undefined"===typeof WebSocket||null===WebSocket)return!0;b=a.headers.etag;c=a.headers["updates-via"];a=a.uri;b&&c&&(this.graph[a]={etag:b,via:c},this.register(c,a));return!0};b.prototype.onUpdate=function(a,b){return this.fetcher.refresh(c.sym(a))};return b}();if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0))for(G in c)C.call(c,G)&&(K=c[G],module.exports[G]=K);c.Fetcher=function(b,a,f){this.store=b;this.thisURI="http://dig.csail.mit.edu/2005/ajar/ajaw/rdf/sources.js#SourceFetcher";
this.timeout=a?a:3E4;this.async=null!=f?f:!0;this.appNode=this.store.bnode();this.store.fetcher=this;this.requested={};this.lookedUp={};this.handlers=[];this.mediatypes={};var e=this,h=this.store,d={};d.link=c.Namespace("http://www.w3.org/2007/ont/link#");d.http=c.Namespace("http://www.w3.org/2007/ont/http#");d.httph=c.Namespace("http://www.w3.org/2007/ont/httph#");d.rdf=c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");d.rdfs=c.Namespace("http://www.w3.org/2000/01/rdf-schema#");d.dc=c.Namespace("http://purl.org/dc/elements/1.1/");
c.Fetcher.crossSiteProxy=function(a){if(c.Fetcher.crossSiteProxyTemplate)return c.Fetcher.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(a))};c.Fetcher.RDFXMLHandler=function(a){a&&(this.dom=a[0]);this.handlerFactory=function(a){a.handle=function(b){var g=e.store;this.dom||(this.dom=c.Util.parseXML(a.responseText));if("parsererror"==this.dom.documentElement.nodeName)throw e.failFetch(a,"Badly formed XML in "+a.resource.uri),Error("Badly formed XML in "+a.resource.uri);var f=g.any(a.req,
d.link("requestedURI")),f=f?g.sym(f.value):a.resource;(new c.RDFParser(g)).parse(this.dom,f.uri,f);g.add(f,d.rdf("type"),d.link("RDFDocument"),e.appNode);b()}}};c.Fetcher.RDFXMLHandler.term=this.store.sym(this.thisURI+".RDFXMLHandler");c.Fetcher.RDFXMLHandler.toString=function(){return"RDFXMLHandler"};c.Fetcher.RDFXMLHandler.register=function(a){a.mediatypes["application/rdf+xml"]={}};c.Fetcher.RDFXMLHandler.pattern=/application\/rdf\+xml/;c.Fetcher.doGRDDL=function(a,b,c,d){e.requestURI("http://www.w3.org/2005/08/online_xslt/xslt?xslfile="+
escape(c)+"&xmlfile="+escape(d),b)};c.Fetcher.XHTMLHandler=function(a){a&&(this.dom=a[0]);this.handlerFactory=function(a){a.handle=function(b){this.dom||(this.dom=("undefined"!=typeof tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):new DOMParser).parseFromString(a.responseText,"application/xml"));var g=e.store,f=this.dom.getElementsByTagName("title");0<f.length&&g.add(a.resource,d.dc("title"),g.literal(f[0].textContent),
a.resource);for(var f=this.dom.getElementsByTagName("link"),h=f.length-1;0<=h;h--)e.linkData(a,f[h].getAttribute("rel"),f[h].getAttribute("href"));(f=this.dom.getElementsByTagName("head")[0])&&(f=f.getAttribute("profile"))&&"http"==c.uri.protocol(f)&&c.Fetcher.doGRDDL(g,a.resource,"http://www.w3.org/2003/11/rdf-in-xhtml-processor",a.resource.uri);g.add(a.resource,d.rdf("type"),d.link("WebPage"),e.appNode);c.rdfa&&c.rdfa.parse&&c.rdfa.parse(this.dom,g,a.resource.uri);b()}}};c.Fetcher.XHTMLHandler.term=
this.store.sym(this.thisURI+".XHTMLHandler");c.Fetcher.XHTMLHandler.toString=function(){return"XHTMLHandler"};c.Fetcher.XHTMLHandler.register=function(a){a.mediatypes["application/xhtml+xml"]={q:.3}};c.Fetcher.XHTMLHandler.pattern=/application\/xhtml/;c.Fetcher.XMLHandler=function(){this.handlerFactory=function(a){a.handle=function(b){for(var d=e.store,f=("undefined"!=typeof tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):
new DOMParser).parseFromString(a.responseText,"application/xml"),h=0;h<f.childNodes.length;h++)if(1==f.childNodes[h].nodeType){h=f.childNodes[h].namespaceURI;if(void 0!=h&&h==h.rdf){e.addStatus(a.req,"Has XML root element in the RDF namespace, so assume RDF/XML.");e.switchHandler("RDFXMLHandler",a,b,[f]);return}for(var h=d.each(d.sym(h),d.sym("http://www.w3.org/2003/g/data-view#namespaceTransformation")),q=0;q<h.length;q++)c.Fetcher.doGRDDL(d,a.resource,h[q].uri,a.resource.uri);break}if(f.doctype&&
"html"==f.doctype.name&&f.doctype.publicId.match(/^-\/\/W3C\/\/DTD XHTML/)&&f.doctype.systemId.match(/http:\/\/www.w3.org\/TR\/xhtml/))e.addStatus(a.req,"Has XHTML DOCTYPE. Switching to XHTML Handler.\n"),e.switchHandler("XHTMLHandler",a,b);else{if((d=f.getElementsByTagName("html")[0])&&(d=d.getAttribute("xmlns"))&&d.match(/^http:\/\/www.w3.org\/1999\/xhtml/)){e.addStatus(a.req,"Has a default namespace for XHTML. Switching to XHTMLHandler.\n");e.switchHandler("XHTMLHandler",a,b);return}e.failFetch(a,
"Unsupported dialect of XML: not RDF or XHTML namespace, etc.\n"+a.responseText.slice(0,80))}}}};c.Fetcher.XMLHandler.term=this.store.sym(this.thisURI+".XMLHandler");c.Fetcher.XMLHandler.toString=function(){return"XMLHandler"};c.Fetcher.XMLHandler.register=function(a){a.mediatypes["text/xml"]={q:.2};a.mediatypes["application/xml"]={q:.2}};c.Fetcher.XMLHandler.pattern=/(text|application)\/(.*)xml/;c.Fetcher.HTMLHandler=function(){this.handlerFactory=function(a){a.handle=function(b){var c=a.responseText;
if(c.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/))e.addStatus(a.req,"Has an XML declaration. We'll assume it's XHTML as the content-type was text/html.\n"),e.switchHandler("XHTMLHandler",a,b);else if(c.match(/.*<!DOCTYPE\s+html[^<]+-\/\/W3C\/\/DTD XHTML[^<]+http:\/\/www.w3.org\/TR\/xhtml[^<]+>/))e.addStatus(a.req,"Has XHTML DOCTYPE. Switching to XHTMLHandler.\n"),e.switchHandler("XHTMLHandler",a,b);else if(c.match(/[^(<html)]*<html\s+[^<]*xmlns=['"]http:\/\/www.w3.org\/1999\/xhtml["'][^<]*>/))e.addStatus(a.req,
"Has default namespace for XHTML, so switching to XHTMLHandler.\n"),e.switchHandler("XHTMLHandler",a,b);else if(c=/<title>([\s\S]+?)<\/title>/im.exec(c)){var f=e.store;f.add(a.resource,d.dc("title"),f.literal(c[1]),a.resource);f.add(a.resource,d.rdf("type"),d.link("WebPage"),e.appNode);b()}else e.failFetch(a,"Sorry, can't yet parse non-XML HTML")}}};c.Fetcher.HTMLHandler.term=this.store.sym(this.thisURI+".HTMLHandler");c.Fetcher.HTMLHandler.toString=function(){return"HTMLHandler"};c.Fetcher.HTMLHandler.register=
function(a){a.mediatypes["text/html"]={q:.3}};c.Fetcher.HTMLHandler.pattern=/text\/html/;c.Fetcher.TextHandler=function(){this.handlerFactory=function(a){a.handle=function(b){var c=a.responseText;c.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/)?(e.addStatus(a.req,"Warning: "+a.resource+" has an XML declaration. We'll assume it's XML but its content-type wasn't XML.\n"),e.switchHandler("XMLHandler",a,b)):c.slice(0,500).match(/xmlns:/)?(e.addStatus(a.req,"May have an XML namespace. We'll assume it's XML but its content-type wasn't XML.\n"),
e.switchHandler("XMLHandler",a,b)):(e.addStatus(a.req,"Plain text document, no known RDF semantics."),e.doneFetch(a,[a.resource.uri]))}}};c.Fetcher.TextHandler.term=this.store.sym(this.thisURI+".TextHandler");c.Fetcher.TextHandler.toString=function(){return"TextHandler"};c.Fetcher.TextHandler.register=function(a){a.mediatypes["text/plain"]={q:.1}};c.Fetcher.TextHandler.pattern=/text\/plain/;c.Fetcher.N3Handler=function(){this.handlerFactory=function(a){a.handle=function(b){c.log.debug("web.js: Parsing as N3 "+
a.resource.uri);b=c.N3Parser(h,h,a.resource.uri,a.resource.uri,null,null,"",null);try{b.loadBuf(a.responseText)}catch(f){e.failFetch(a,"Error trying to parse "+a.resource+" as Notation3:\n"+f+":\n"+f.stack);return}e.addStatus(a.req,"N3 parsed: "+b.statementCount+" triples in "+b.lines+" lines.");e.store.add(a.resource,d.rdf("type"),d.link("RDFDocument"),e.appNode);args=[a.resource.uri];e.doneFetch(a,args)}}};c.Fetcher.N3Handler.term=this.store.sym(this.thisURI+".N3Handler");c.Fetcher.N3Handler.toString=
function(){return"N3Handler"};c.Fetcher.N3Handler.register=function(a){a.mediatypes["text/n3"]={q:"1.0"};a.mediatypes["application/x-turtle"]={q:1};a.mediatypes["text/turtle"]={q:1}};c.Fetcher.N3Handler.pattern=/(application|text)\/(x-)?(rdf\+)?(n3|turtle)/;c.Util.callbackify(this,"request recv headers load fail refresh retract done".split(" "));this.addProtocol=function(a){e.store.add(e.appNode,d.link("protocol"),e.store.literal(a),this.appNode)};this.addHandler=function(a){e.handlers.push(a);a.register(e)};
this.switchHandler=function(a,b,d,f){for(var h=null,q=0;q<this.handlers.length;q++)""+this.handlers[q]==a&&(h=this.handlers[q]);if(void 0==h)throw"web.js: switchHandler: name="+a+" , this.handlers ="+this.handlers+"\nswitchHandler: switching to "+h+"; sf="+e+"; typeof $rdf.Fetcher="+typeof c.Fetcher+";\n\t $rdf.Fetcher.HTMLHandler="+c.Fetcher.HTMLHandler+"\n\n\tsf.handlers="+e.handlers+"\n";(new h(f)).handlerFactory(b);b.handle(d)};this.addStatus=function(a,b){var f=new Date;b="["+f.getHours()+":"+
f.getMinutes()+":"+f.getSeconds()+"."+f.getMilliseconds()+"] "+b;var f=this.store,e=f.the(a,d.link("status"));e&&e.append?e.append(f.literal(b)):c.log.warn("web.js: No list to add to: "+e+","+b)};this.failFetch=function(a,b){this.addStatus(a.req,b);h.add(a.resource,d.link("error"),b);this.requested[c.uri.docpart(a.resource.uri)]=!1;a.userCallback&&a.userCallback(!1,"Fetch of <"+a.resource.uri+"> failed: "+b,a);this.fireCallbacks("fail",[a.requestedURI,b]);a.abort();return a};this.linkData=function(a,
b,f){!f||"alternate"!=b&&"seeAlso"!=b&&"meta"!=b&&"describedby"!=b||(b=h.sym(c.uri.join(f,a.resource.uri)),b.uri!=a.resource&&h.add(a.resource,d.rdfs("seeAlso"),b,a.resource))};this.doneFetch=function(a,b){this.addStatus(a.req,"Done.");this.requested[a.resource.uri]="done";a.userCallback&&a.userCallback(!0,void 0,a);this.fireCallbacks("done",b)};this.store.add(this.appNode,d.rdfs("label"),this.store.literal("This Session"),this.appNode);["http","https","file","chrome"].map(this.addProtocol);[c.Fetcher.RDFXMLHandler,
c.Fetcher.XHTMLHandler,c.Fetcher.XMLHandler,c.Fetcher.HTMLHandler,c.Fetcher.TextHandler,c.Fetcher.N3Handler].map(this.addHandler);this.nowKnownAs=function(a,b){this.lookedUp[a.uri]?this.lookedUp[b.uri]||this.lookUpThing(b,a):this.lookedUp[b.uri]&&(this.lookedUp[a.uri]||this.lookUpThing(a,b))};this.lookUpThing=function(a,b,d,f,e){a=h.uris(a);var q=!0,u="",v={};if("undefined"!==typeof a)for(var r=0;r<a.length;r++){var A=a[r];v[A]=!0;this.lookedUp[A]=!0;var B=this;(function(a){B.requestURI(c.uri.docpart(a),
b,d,function(b,c,d){b?f&&f(!0,a):(f&&f(!1,c),q=!1,u+=c+"\n");delete v[A];for(x in v)return;e&&e(q,u)})})(A)}return a.length};this.nowOrWhenFetched=function(a,b,c){if("fetched"==this.getState(a))return c(!0);this.requestURI(a,b,!1,c)};this.getHeader=function(a,b){for(var c=this.store,d=c.each(void 0,tabulator.ns.link("requestedURI"),a.uri),f=0;f<d.length;f++){var e=d[f];if(void 0!==e){var h=c.any(e,tabulator.ns.link("response"));if(void 0!==e)return c=c.each(h,tabulator.ns.httph(b.toLowerCase())),
c.length?c.map(function(a){return a.value}):[]}}};this.proxyIfNecessary=function(a){return"undefined"!=typeof tabulator&&tabulator.isExtension?a:c.Fetcher.crossSiteProxyTemplate&&document&&document.location&&"https:"===(""+document.location).slice(0,6)&&"http:"===a.slice(0,5)?c.Fetcher.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(a)):a};this.requestURI=function(a,b,f,e){if(0<=a.indexOf("#"))throw"requestURI should not be called with fragid: "+a;var h=c.uri.protocol(a);if("tel"==h||"mailto"==
h||"urn"==h)return null;f=!!f;var q=this.store,u=arguments,v=q.sym(a);if(!f&&"undefined"!=typeof this.requested[a])return null;this.fireCallbacks("request",u);this.requested[a]=!0;b&&b.uri&&q.add(v.uri,d.link("requestedBy"),b.uri,this.appNode);if(h="undefined"!=typeof jQuery)A=q.bnode();else{var r=c.Util.XMLHTTPFactory(),A=r.req=q.bnode();r.resource=v;r.requestedURI=u[0]}var B=q.collection(),n=this,t=new Date,t="["+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+"] ";q.add(A,d.rdfs("label"),q.literal(t+
" Request for "+a),this.appNode);q.add(A,d.link("requestedURI"),q.literal(a),this.appNode);q.add(A,d.link("status"),q.collection(),n.req);var C=function(a){return function(b){if(c.Fetcher.crossSiteProxyTemplate&&document&&document.location&&!a.proxyUsed){b=c.uri.hostpart;var g=""+document.location,k=a.resource.uri;b(g)&&b(k)&&b(g)!=b(k)&&(newURI=c.Fetcher.crossSiteProxy(k),n.addStatus(a.req,"BLOCKED -> Cross-site Proxy to <"+newURI+">"),a.aborted||(b=n.store,g=a.req,b.add(g,d.http("redirectedTo"),
b.sym(newURI),g),a.abort(),a.aborted=!0,n.addStatus(g,"done - redirected"),n.requested[a.resource.uri]="redirected",g=n.requestURI(newURI,a.resource,f,e),g.proxyUsed=!0,g&&g.req&&b.add(a.req,b.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),g.req,n.appNode)))}else a.withCredentials?(a.abort(),a.withCredentials=!1,n.addStatus(a.req,"Credentials SUPPRESSED to see if that helps"),a.send()):n.failFetch(a,"XHR Error: "+b)}},G=function(b){return function(){var e=function(){if(!b.handleResponseDone){b.handleResponseDone=
!0;var e=null,k=b.req;n.fireCallbacks("recv",u);var h=n.store,m=h.bnode();h.add(k,d.link("response"),m);h.add(m,d.http("status"),h.literal(b.status),m);h.add(m,d.http("statusText"),h.literal(b.statusText),m);b.headers={};if("http"==c.uri.protocol(b.resource.uri)||"https"==c.uri.protocol(b.resource.uri)){b.headers=c.Util.getHTTPHeaders(b);for(var p in b.headers)h.add(m,d.httph(p.toLowerCase()),b.headers[p].trim(),m)}n.fireCallbacks("headers",[{uri:a,headers:b.headers}]);if(400<=b.status)10<b.responseText.length&&
h.add(m,d.http("content"),h.literal(b.responseText),m),n.failFetch(b,"HTTP error for "+b.resource+": "+b.status+" "+b.statusText);else{var q=b.headers["content-location"],m=function(a){var b=k;for(q&&h.any(b,d.link("requestedURI"))!=q&&h.add(h.sym(q),d.rdf("type"),a,n.appNode);;){var c=h.any(b,d.link("requestedURI"));c&&c.value&&h.add(h.sym(c.value),d.rdf("type"),a,n.appNode);b=h.any(void 0,h.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),b);if(!b)break;c=h.any(b,h.sym("http://www.w3.org/2007/ont/link#response"));
if(!c)break;c=h.any(c,h.sym("http://www.w3.org/2007/ont/http#status"));if(!c)break;if("301"!=c&&"302"!=c)break}};200==b.status&&(m(d.link("Document")),(p=b.headers["content-type"])&&(0!=p.indexOf("image/")&&0!=p.indexOf("application/pdf")||m(h.sym("http://purl.org/dc/terms/Image"))));if("file"==c.uri.protocol(b.resource.uri)||"chrome"==c.uri.protocol(b.resource.uri))switch(b.resource.uri.split(".").pop()){case "rdf":case "owl":b.headers["content-type"]="application/rdf+xml";break;case "n3":case "nt":case "ttl":b.headers["content-type"]=
"text/n3";break;default:b.headers["content-type"]="text/xml"}if(q){m=c.uri.join(b.resource.uri,q);if(!f&&m!=b.resource.uri&&n.requested[m]){n.doneFetch(b,u);b.abort();return}n.requested[m]=!0}for(m=0;m<n.handlers.length;m++)if(b.headers["content-type"]&&b.headers["content-type"].match(n.handlers[m].pattern)){e=new n.handlers[m];B.append(n.handlers[m].term);break}var r;try{r=b.getResponseHeader("link")}catch(t){}if(r){m=null;r=r.replace(/ /g,"").split(";");for(p=1;p<r.length;p++)lr=r[p].split("="),
"rel"==lr[0]&&(m=lr[1]);r=r[0];r.length&&"<"==r[0]&&">"==r[r.length-1]&&r.slice&&(r=r.slice(1,-1));m&&n.linkData(b,m,r)}if(e)try{e.handlerFactory(b)}catch(F){n.failFetch(b,"Exception handling content-type "+b.headers["content-type"]+" was: "+F)}else n.doneFetch(b,u)}}};switch(b.readyState){case 0:var e=b.resource.uri,k;if(this.crossSiteProxyTemplate&&document&&document.location){k=c.uri.hostpart;var h=""+document.location;if(k(h)&&k(e)&&k(h)!=k(e)){k=this.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(e));
n.addStatus(b.req,"BLOCKED -> Cross-site Proxy to <"+k+">");if(b.aborted)break;e=n.store;h=b.req;e.add(h,d.http("redirectedTo"),e.sym(k),h);var m=b.req=e.bnode();e.add(h,d.http("redirectedRequest"),m,b.req);var p=new Date,p="["+p.getHours()+":"+p.getMinutes()+":"+p.getSeconds()+"] ";e.add(m,d.rdfs("label"),e.literal(p+" Request for "+k),this.appNode);e.add(m,d.link("status"),e.collection(),n.req);e.add(m,d.link("requestedURI"),e.literal(k),this.appNode);m=e.bnode();e.add(h,d.link("response"),m);b.abort();
b.aborted=!0;n.addStatus(h,"done");b.userCallback&&b.userCallback(!0);n.fireCallbacks("done",u);n.requested[b.resource.uri]="redirected";(k=n.requestURI(k,b.resource))&&k.req&&e.add(b.req,e.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),k.req,n.appNode);break}}n.failFetch(b,"HTTP Blocked. (ReadyState 0) Cross-site violation for <"+a+">");break;case 4:if(e(),b.handle){if("redirected"===n.requested[b.resource.uri])break;n.fireCallbacks("load",u);b.handle(function(){n.doneFetch(b,u)})}else n.addStatus(b.req,
"Fetch OK. No known semantics."),n.doneFetch(b,u)}}},E=a;"undefined"!=typeof tabulator&&tabulator.preferences.get("offlineModeUsingLocalhost")&&"http://"==E.slice(0,7)&&"localhost/"!=E.slice(7,17)&&(E="http://localhost/"+E.slice(7),c.log.warn("Localhost kludge for offline use: actually getting <"+E+">"));q="https:"===E.slice(0,6);t=this.proxyIfNecessary(E);if("undefined"!==typeof jQuery&&jQuery.ajax)r=jQuery.ajax({url:t,accepts:{"*":"text/turtle,text/n3,application/rdf+xml"},processData:!1,xhrFields:{withCredentials:q},
timeout:n.timeout,error:function(a,b,c){a.req=A;a.userCallback=e;a.resource=v;a.requestedURI=E;"timeout"==b?n.failFetch(a,"requestTimeout"):C(a)(c)},success:function(a,b,c){c.req=A;c.userCallback=e;c.resource=v;c.requestedURI=E;G(c)()}}),r.req=A,r.userCallback=e,r.resource=v,r.requestedURI=E,r.actualProxyURI=t;else{r=c.Util.XMLHTTPFactory();r.onerror=C(r);r.onreadystatechange=G(r);r.timeout=n.timeout;r.withCredentials=q;r.actualProxyURI=t;r.req=A;r.userCallback=e;r.resource=v;r.requestedURI=E;r.ontimeout=
function(){n.failFetch(r,"requestTimeout")};try{r.open("GET",t,this.async)}catch(J){return this.failFetch(r,"XHR open for GET failed for <"+E+">:\n\t"+J)}}if("undefined"!=typeof tabulator&&tabulator.isExtension&&r.channel&&("http"==c.uri.protocol(r.resource.uri)||"https"==c.uri.protocol(r.resource.uri)))try{r.channel.notificationCallbacks={getInterface:function(a){return a.equals(Components.interfaces.nsIChannelEventSink)?{onChannelRedirect:function(a,e,f){if(!r.aborted){a=n.store;e=e.URI.spec;f=
r.req;n.addStatus(r.req,"Redirected: "+r.status+" to <"+e+">");a.add(f,d.http("redirectedTo"),a.sym(e),r.req);var g=r.req=a.bnode();a.add(f,d.http("redirectedRequest"),g,r.req);var h=new Date,h="["+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()+"] ";a.add(g,d.rdfs("label"),a.literal(h+" Request for "+e),this.appNode);a.add(g,d.link("status"),a.collection(),n.req);a.add(g,d.link("requestedURI"),a.literal(e),this.appNode);g=a.bnode();a.add(f,d.link("response"),g);a.add(g,d.http("status"),a.literal(r.status),
g);r.statusText&&a.add(g,d.http("statusText"),a.literal(r.statusText),g);303!=r.status-0&&(a.HTTPRedirects[r.resource.uri]=e);301==r.status-0&&b&&(h=c.uri.docpart(b.uri),g="Warning: "+r.resource+" has moved to <"+e+">.",b&&(g+=" Link in <"+h+" >should be changed",a.add(h,a.sym("http://www.w3.org/2007/ont/link#warning"),g,n.appNode)));r.abort();r.aborted=!0;n.addStatus(f,"done");n.fireCallbacks("done",u);n.requested[r.resource.uri]="redirected";f=e.indexOf("#");0<=f&&(g="Warning: "+r.resource+" HTTP redirects to"+
e+' which should not contain a "#" sign',a.add(r.resource,a.sym("http://www.w3.org/2007/ont/link#warning"),g),e=e.slice(0,f));(e=n.requestURI(e,r.resource))&&e.req&&a.add(r.req,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),e.req,n.appNode)}},asyncOnChannelRedirect:function(a,e,f,g){if(!r.aborted){a=n.store;e=e.URI.spec;f=r.req;n.addStatus(r.req,"Redirected: "+r.status+" to <"+e+">");a.add(f,d.http("redirectedTo"),a.sym(e),r.req);g=r.req=a.bnode();a.add(f,d.http("redirectedRequest"),g,
r.req);var h=new Date,h="["+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()+"] ";a.add(g,d.rdfs("label"),a.literal(h+" Request for "+e),this.appNode);a.add(g,d.link("status"),a.collection(),n.req);a.add(g,d.link("requestedURI"),a.literal(e),this.appNode);g=a.bnode();a.add(f,d.link("response"),g);a.add(g,d.http("status"),a.literal(r.status),g);r.statusText&&a.add(g,d.http("statusText"),a.literal(r.statusText),g);303!=r.status-0&&(a.HTTPRedirects[r.resource.uri]=e);301==r.status-0&&b&&(h=c.uri.docpart(b.uri),
g="Warning: "+r.resource+" has moved to <"+e+">.",b&&(g+=" Link in <"+h+" >should be changed",a.add(h,a.sym("http://www.w3.org/2007/ont/link#warning"),g,n.appNode)));r.abort();r.aborted=!0;n.addStatus(f,"done");r.userCallback&&r.userCallback(!0);n.fireCallbacks("done",u);n.requested[r.resource.uri]="redirected";f=e.indexOf("#");0<=f&&(g="Warning: "+r.resource+" HTTP redirects to"+e+' which should not contain a "#" sign',a.add(r.resource,a.sym("http://www.w3.org/2007/ont/link#warning"),g),e=e.slice(0,
f));(e=n.requestURI(e,r.resource))&&e.req&&a.add(r.req,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),e.req,n.appNode)}}}:Components.results.NS_NOINTERFACE}}}catch(K){return n.failFetch(r,"@@ Couldn't set callback for redirects: "+K)}try{var q="",I;for(I in this.mediatypes){""!=q&&(q+=", ");var q=q+I,M;for(M in this.mediatypes[I])q+=";"+M+"="+this.mediatypes[I][M]}r.setRequestHeader("Accept",q)}catch(Q){throw"Can't set Accept header: "+Q;}if(h)this.addStatus(r.req,"HTTP Request sent (using jQuery)");
else{try{r.send(null)}catch(T){return this.failFetch(r,"XHR send failed:"+T)}setTimeout(function(){4!=r.readyState&&n.isPending(r.resource.uri)&&n.failFetch(r,"requestTimeout")},this.timeout);this.addStatus(r.req,"HTTP Request sent.")}return r};this.objectRefresh=function(a){a=h.uris(a);if("undefined"!=typeof a)for(var b=0;b<a.length;b++)this.refresh(this.store.sym(c.uri.docpart(a[b])))};this.unload=function(a){this.store.removeMany(void 0,void 0,void 0,a);delete this.requested[a.uri]};this.refresh=
function(a){this.unload(a);this.fireCallbacks("refresh",arguments);this.requestURI(a.uri,void 0,!0)};this.retract=function(a){this.store.removeMany(void 0,void 0,void 0,a);a.uri&&delete this.requested[c.uri.docpart(a.uri)];this.fireCallbacks("retract",arguments)};this.getState=function(a){return"undefined"!=typeof this.requested[a]?this.requested[a]?this.isPending(a)?"requested":"fetched":"failed":"unrequested"};this.isPending=function(a){return 1==this.requested[a]}};c.fetcher=function(b,a,f){return new c.Fetcher(b,
a,f)};c.parse=function(b,a,f,e){try{if("text/n3"==e||"text/turtle"==e){c.N3Parser(a,a,f,f,null,null,"",null).loadBuf(b);return}if("application/rdf+xml"==e){(new c.RDFParser(a)).parse(c.Util.parseXML(b),f,a.sym(f));return}if("application/rdfa"==e){c.rdfa&&c.rdfa.parse&&c.rdfa.parse(c.Util.parseXML(b),a,f);return}if("application/sparql-update"==e){spaqlUpdateParser(store,b,f);c.rdfa&&c.rdfa.parse&&c.rdfa.parse(c.Util.parseXML(b),a,f);return}}catch(h){throw"Error trying to parse <"+f+"> as "+e+":\n"+
h+":\n"+h.stack;}throw"Don't know how to parse "+e+" yet";};c.serialize=function(b,a,f,e){var h=c.Serializer(a);b=a.statementsMatching(void 0,void 0,void 0,b);h.suggestNamespaces(a.namespaces);h.setBase(f);switch(e){case "application/rdf+xml":a=h.statementsToXML(b);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":a=h.statementsToN3(b);break;default:throw"serialise: Content-type "+content_type+" not supported for data write";}return a};"undefined"!==typeof exports?
("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports.$rdf=c):("function"===typeof define&&define.amd&&define([],function(){return c}),Q.$rdf=c)})(this);